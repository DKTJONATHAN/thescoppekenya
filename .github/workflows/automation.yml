- name: Generate article
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          UNSPLASH_ACCESS_KEY: ${{ secrets.UNSPLASH_ACCESS_KEY }}
          MANUAL_TOPIC: ${{ inputs.manual_topic }}
        run: |
          python << 'EOF'
          import os, json, datetime, requests, re, random, time

          # --- 1. CONFIG & ROTATION ---
          today_str = datetime.datetime.utcnow().strftime("%Y-%m-%d")
          current_hour = datetime.datetime.utcnow().hour
          
          # Hard rotation to ensure variety
          countries = ['Kenya', 'Tanzania', 'Uganda']
          country = countries[current_hour % 3]
          
          categories = ["Politics", "Celebrity Gossip", "Social Media Drama"]
          topic = os.environ.get('MANUAL_TOPIC') or random.choice(categories)

          # --- 2. THE NAME ANCHORS (To force specific mentions) ---
          anchors = {
              "Kenya": "William Ruto, Rigathi Gachagua, Raila Odinga, Khaligraph Jones, Eric Omondi, Bahati",
              "Tanzania": "Samia Suluhu, Diamond Platnumz, Harmonize, Alikiba, Zuchu, Mange Kimambi",
              "Uganda": "Yoweri Museveni, Bobi Wine, Muhoozi Kainerugaba, Sheebah Karungi, Jose Chameleone"
          }
          local_vips = anchors.get(country, "")

          print(f"ðŸŒ Target: {country} | Topic: {topic} | Mentioning: {local_vips}")

          # --- 3. THE SAVAGE PROMPT ---
          prompt = f"""
          Role: You are 'The Tea Master', the most savage, unfiltered blogger in East Africa. 
          Task: Write a factual but BRUTALLY opinionated wrap-up of a major event involving {topic} in {country} from the past week.
          
          STRICT RULES:
          1. YOU MUST MENTION NAMES. Use the names of key figures like {local_vips} if they are relevant to the topic.
          2. DO NOT BE NICE. If someone is moving like a 'clown', say it.
          3. Use heavy slang: Wueh, Kwani, Tea, Sasa Basi, Me nimejam, 'Character Development'.
          4. Be factual about what happened, but your commentary must be 100% opinionated and spicy.
          
          OUTPUT FORMAT:
          TITLE: [Savage Clickbait Title]
          SLUG: [url-friendly-slug]
          EXCERPT: [One sentence that burns specific people]
          BODY:
          [Article content with ## Headers. Start with the names and the drama immediately.]
          """

          # --- 4. DIRECT POST WITH INFINITE RETRY ---
          url = f"https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key={os.environ['GEMINI_API_KEY']}"
          headers = {'Content-Type': 'application/json'}
          payload = {"contents": [{"parts": [{"text": prompt}]}]}
          
          full_text = ""
          wait = 30
          while True:
              try:
                  resp = requests.post(url, json=payload, headers=headers)
                  if resp.status_code == 200:
                      full_text = resp.json()['candidates'][0]['content']['parts'][0]['text']
                      break
                  elif resp.status_code in [429, 500, 503]:
                      print(f"â³ API Busy/Quota. Sleeping {wait}s...")
                      time.sleep(wait)
                      wait = min(wait * 2, 300)
                  else:
                      print(f"âŒ Error: {resp.text}")
                      exit(1)
              except Exception as e:
                  print(f"âš ï¸ Network error: {e}")
                  time.sleep(30)

          # --- 5. PARSING & SAVING ---
          parsed = {"TITLE": "Untitled", "SLUG": "post", "EXCERPT": "", "BODY": ""}
          try:
              parsed["TITLE"] = re.search(r"TITLE:(.*)", full_text).group(1).strip()
              parsed["SLUG"] = re.search(r"SLUG:(.*)", full_text).group(1).strip()
              parsed["EXCERPT"] = re.search(r"EXCERPT:(.*)", full_text).group(1).strip()
              parsed["BODY"] = full_text.split("BODY:")[1].strip()
          except:
              # Fallback if parsing fails
              parsed["SLUG"] = f"tea-{int(time.time())}"

          content = f"---\ntitle: \"{parsed['TITLE']}\"\ndate: \"{today_str}\"\nexcerpt: \"{parsed['EXCERPT']}\"\ncountry: \"{country}\"\n---\n\n{parsed['BODY']}"
          
          os.makedirs("content/posts", exist_ok=True)
          with open(f"content/posts/{parsed['SLUG']}.md", "w") as f:
              f.write(content)
          print(f"âœ… Served the tea on {country} with names.")
          EOF
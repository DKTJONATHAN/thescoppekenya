name: East Africa Gossip Bot (Dynamic & Real-Time)

on:
  schedule:
    # Runs 6 times a day (Every 4 hours)
    - cron: '0 1 * * *'   # 1. Kenya
    - cron: '0 5 * * *'   # 2. Uganda
    - cron: '0 9 * * *'   # 3. Tanzania
    - cron: '0 13 * * *'  # 4. Kenya
    - cron: '0 17 * * *'  # 5. Uganda
    - cron: '0 21 * * *'  # 6. Tanzania
  workflow_dispatch:
    inputs:
      manual_topic:
        description: 'Force a topic (optional)'
        required: false
        default: ''

permissions:
  contents: write

env:
  DEFAULT_BRANCH: main
  POSTS_DIR: content/posts

jobs:
  generate-and-publish:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          ref: ${{ env.DEFAULT_BRANCH }}
          token: ${{ secrets.PERSONAL_GITHUB_TOKEN }}
          persist-credentials: true

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests google-generativeai python-slugify

      - name: Generate article with Gemini
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          UNSPLASH_ACCESS_KEY: ${{ secrets.UNSPLASH_ACCESS_KEY }}
          MANUAL_TOPIC: ${{ inputs.manual_topic }}
        run: |
          python << 'EOF'
          import os, json, datetime, requests, random, time, re
          import google.generativeai as genai
          from slugify import slugify

          # --- CONFIGURATION ---
          today_str = datetime.datetime.utcnow().strftime("%Y-%m-%d")
          full_date_str = datetime.datetime.utcnow().strftime("%A, %B %d, %Y") # e.g. Sunday, February 01, 2026
          current_hour = datetime.datetime.utcnow().hour
          
          # Configure Gemini SDK
          api_key = os.environ.get("GEMINI_API_KEY")
          if not api_key: raise SystemExit("Missing GEMINI_API_KEY")
          
          genai.configure(api_key=api_key)

          # --- 1. COUNTRY ROTATION ---
          if current_hour < 4: country_name = 'Kenya'
          elif current_hour < 8: country_name = 'Uganda'
          elif current_hour < 12: country_name = 'Tanzania'
          elif current_hour < 16: country_name = 'Kenya'
          elif current_hour < 20: country_name = 'Uganda'
          else: country_name = 'Tanzania'

          # --- 2. DYNAMIC TOPIC PICKER ---
          # We randomize the category so every run feels different.
          categories = [
              "Entertainment", 
              "Sports", 
              "Politics", 
              "Business", 
              "Technology"
          ]
          
          # Check for manual input
          manual_input = os.environ.get('MANUAL_TOPIC', '').strip()
          
          if manual_input:
              search_query = f"{manual_input} news {country_name} {today_str}"
              selected_category = "Manual"
              print(f"ðŸŽ¯ Manual Topic: {manual_input}")
          else:
              # Pick a random category
              selected_category = random.choice(categories)
              
              # Construct a SEARCH QUERY that forces freshness
              # e.g. "trending Sports news Kenya today Sunday, February 01, 2026"
              search_query = f"trending {selected_category} news in {country_name} today {full_date_str}"
              print(f"ðŸŒ Searching for: [{selected_category}] in [{country_name}]")

          # --- 3. JSON CLEANER ---
          def clean_json(text):
              text = re.sub(r'```json\s*', '', text)
              text = re.sub(r'```', '', text)
              return text.strip()

          # --- 4. IMAGE HELPER ---
          def get_real_image(query):
              access_key = os.environ.get("UNSPLASH_ACCESS_KEY")
              fallback = "https://images.unsplash.com/photo-1504711434969-e33886168f5c?w=800"
              if not access_key: return fallback
              try:
                  url = f"https://api.unsplash.com/photos/random?query={query}&orientation=landscape&client_id={access_key}"
                  resp = requests.get(url, timeout=10)
                  if resp.status_code == 200:
                      return resp.json()['urls']['regular']
              except: pass
              return fallback

          # --- 5. THE "ADAPTIVE YAPPER" PROMPT ---
          prompt = f"""
          Current Date: {full_date_str}
          Search Query: "{search_query}"
          Category: {selected_category}

          ROLE: You are "The Tea Master", East Africa's sharpest gossip blogger.
          
          TASK: 
          1. Use Google Search to find the HOTTEST story for the selected category & date.
          2. Write a blog post about it.

          TONE ADAPTATION:
          - If {selected_category} == "Politics": Focus on the SCANDAL, the DRAMA, or the INSULTS. Ignore boring bills.
          - If {selected_category} == "Sports": Write like a DIE-HARD FAN. Celebrate wins, roast losers.
          - If {selected_category} == "Business": Focus on MONEY GOSSIP. Who is broke? Who is rich? Which company is dying?
          - If {selected_category} == "Technology": Focus on SCAMS, social media bans, or crazy new gadgets.
          - General: Use slang ("Wueh!", "Imagine!", "Tea", "Kwani?").

          STRICT CONTENT RULES:
          - MUST be a real story from TODAY or YESTERDAY.
          - MUST mention real names, locations, and quotes.
          - DO NOT write generic "Internet is buzzing" fluff. Be specific.

          OUTPUT FORMAT (JSON ONLY):
          {{
            "title": "A viral, clickbait title (Max 12 words)",
            "slug": "url-friendly-slug",
            "excerpt": "A single, spicy sentence hook.",
            "category": "{selected_category}",
            "tags": ["tag1", "tag2", "tag3"],
            "image_keyword": "Specific visual search term for the story",
            "body": "The article body in Markdown. Use ## Subheadings. Keep it punchy."
          }}
          """

          # --- 6. CALL GEMINI (STABLE) ---
          MODEL_NAME = 'gemini-1.5-flash'
          
          tools = [
              {'google_search_retrieval': {
                  'dynamic_retrieval_config': {
                      'mode': 'dynamic',
                      'dynamic_threshold': 0.3
                  }
              }}
          ]

          parsed = None
          max_retries = 3

          for attempt in range(max_retries):
              print(f"ðŸ¤– Attempt {attempt+1}...")
              try:
                  model = genai.GenerativeModel(MODEL_NAME)
                  
                  response = model.generate_content(
                      prompt,
                      tools=tools,
                      generation_config=genai.types.GenerationConfig(
                          response_mime_type="application/json"
                      )
                  )
                  
                  clean_text = clean_json(response.text)
                  parsed = json.loads(clean_text)
                  
                  # Sanity Check
                  if "buzzing today" in parsed['title'].lower():
                      raise ValueError("Generic title detected, retrying...")
                      
                  print(f"ðŸ”¥ Success! Story: {parsed['title']}")
                  break 
                  
              except Exception as e:
                  print(f"âš ï¸ Error: {e}")
                  time.sleep(10)
                  continue

          if not parsed:
              print("âŒ All attempts failed. Exiting.")
              exit(0)

          # --- 7. ASSEMBLE FRONT MATTER ---
          image_url = get_real_image(parsed['image_keyword'])
          
          authors = ["The Tea Master", "Nairobi Gossip Desk", "Bongo Flavor", "Kampala Insider"]
          
          final_file = f"""---
          title: "{parsed['title']}"
          slug: "{parsed['slug']}"
          excerpt: "{parsed['excerpt']}"
          image: "{image_url}"
          category: "{parsed['category']}"
          author: "{random.choice(authors)}"
          date: "{today_str}"
          tags: {json.dumps(parsed['tags'])}
          featured: false
          ---

          {parsed['body']}
          """

          import textwrap
          final_file = textwrap.dedent(final_file).strip()
          
          out_dir = os.path.join(os.getcwd(), os.environ.get("POSTS_DIR", "content/posts"))
          os.makedirs(out_dir, exist_ok=True)
          
          filename = f"{parsed['slug']}.md"
          filepath = os.path.join(out_dir, filename)
          
          with open(filepath, "w", encoding="utf-8") as f:
              f.write(final_file)
          
          print(f"âœ… Published: {filepath}")
          EOF

      - name: Commit and push article
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "content: fresh tea served â˜• (${{ github.run_id }})"
          branch: ${{ env.DEFAULT_BRANCH }}
          file_pattern: ${{ env.POSTS_DIR }}/*.md
          commit_user_name: "Gossip Bot"
          commit_user_email: "actions@github.com"
        env:
          GITHUB_TOKEN: ${{ secrets.PERSONAL_GITHUB_TOKEN }}
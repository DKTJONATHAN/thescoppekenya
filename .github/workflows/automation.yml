name: East Africa Gossip Bot (Strict Pro & Infinite Retry)

on:
  schedule:
    - cron: '0 0 * * *'   # 3 AM EAT
    - cron: '0 4 * * *'   # 7 AM EAT
    - cron: '0 8 * * *'   # 11 AM EAT
    - cron: '0 12 * * *'  # 3 PM EAT
    - cron: '0 16 * * *'  # 7 PM EAT
    - cron: '0 20 * * *'  # 11 PM EAT
  workflow_dispatch:
    inputs:
      manual_topic:
        description: 'Force a topic (optional)'
        required: false
        default: ''

permissions:
  contents: write

env:
  DEFAULT_BRANCH: main
  POSTS_DIR: content/posts

jobs:
  generate-and-publish:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          ref: ${{ env.DEFAULT_BRANCH }}
          token: ${{ secrets.PERSONAL_GITHUB_TOKEN }}
          persist-credentials: true

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests

      - name: Generate article with Gemini
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          UNSPLASH_ACCESS_KEY: ${{ secrets.UNSPLASH_ACCESS_KEY }}
          MANUAL_TOPIC: ${{ inputs.manual_topic }}
          POSTS_DIR: ${{ env.POSTS_DIR }}
        run: |
          python << 'EOF'
          import os, json, datetime, requests, re, random, time

          # --- CONFIGURATION ---
          today_str = datetime.datetime.utcnow().strftime("%Y-%m-%d")
          full_date_str = datetime.datetime.utcnow().strftime("%A, %B %d, %Y")
          current_hour = datetime.datetime.utcnow().hour

          # --- 1. COUNTRY ROTATION ---
          if current_hour < 2:   country_name = 'Tanzania'
          elif current_hour < 6: country_name = 'Kenya'
          elif current_hour < 10: country_name = 'Uganda'
          elif current_hour < 14: country_name = 'Tanzania'
          elif current_hour < 18: country_name = 'Kenya'
          else:                   country_name = 'Uganda'

          # --- 2. TOPIC SELECTION ---
          manual_input = os.environ.get('MANUAL_TOPIC', '').strip()
          categories = ["Entertainment", "Sports", "Politics", "Business", "Technology"]
          
          if manual_input:
              topic = manual_input
          else:
              topic = random.choice(categories)

          print(f"ðŸŽ¯ Target: {country_name} | Topic: {topic}")

          # --- 3. HELPER FUNCTIONS ---
          def get_real_image(query):
              access_key = os.environ.get("UNSPLASH_ACCESS_KEY")
              fallback_image = "https://images.unsplash.com/photo-1504711434969-e33886168f5c?w=1200"
              
              if not access_key: return fallback_image
              
              url = f"https://api.unsplash.com/photos/random?query={query}&orientation=landscape&client_id={access_key}"
              try:
                  resp = requests.get(url, timeout=10)
                  if resp.status_code == 200:
                      return resp.json()['urls']['regular']
              except Exception: pass
              return fallback_image

          # --- 4. PROMPT (No Search Instructions, Just Knowledge) ---
          spec_text = f"""
          Current Date: {full_date_str}
          Target Country: {country_name}
          Topic: {topic}
          
          ROLE: You are "The Tea Master", East Africa's sharpest gossip blogger.
          
          TASK: Tell me what is trending regarding "{topic}" in {country_name} right now. Write a spicy blog post about it based on your internal knowledge.
          
          TONE:
          - Use slang ("Wueh!", "Imagine!", "Tea", "Kwani?").
          - Be dramatic and engaging.

          *** STRICT OUTPUT FORMAT ***
          Do NOT write Markdown/YAML yourself. Provide raw data labeled exactly like this:

          TITLE: [Insert punchy clickbait title]
          SLUG: [url-friendly-slug-lowercase]
          EXCERPT: [One spicy sentence hook]
          CATEGORY: {topic}
          TAGS: [tag1, tag2, tag3]
          IMAGE_KEYWORD: [Visual search term for the story]
          BODY:
          [Write the full article here using ## Headers. NO Title at start.]
          """

          api_key = os.environ.get("GEMINI_API_KEY")
          if not api_key: raise SystemExit("Missing GEMINI_API_KEY")

          # --- 5. CALL GEMINI (Infinite Retry Loop) ---
          # Using gemini-1.5-pro (The standard Pro model - 'latest' alias causes 404s)
          url = f"https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-pro:generateContent?key={api_key}"
          
          headers = { "Content-Type": "application/json" }
          
          # NO TOOLS. PURE PROMPT.
          payload = {
              "contents": [{ "parts": [{ "text": spec_text }] }],
              "safetySettings": [
                  {"category": "HARM_CATEGORY_HARASSMENT", "threshold": "BLOCK_NONE"},
                  {"category": "HARM_CATEGORY_HATE_SPEECH", "threshold": "BLOCK_NONE"},
                  {"category": "HARM_CATEGORY_SEXUALLY_EXPLICIT", "threshold": "BLOCK_NONE"},
                  {"category": "HARM_CATEGORY_DANGEROUS_CONTENT", "threshold": "BLOCK_NONE"}
              ]
          }

          full_text = ""
          attempt = 0
          
          # INFINITE RETRY LOOP
          while True:
              attempt += 1
              print(f"ðŸ¤– Attempt {attempt}...")
              try:
                  resp = requests.post(url, headers=headers, json=payload, timeout=120)
                  
                  if resp.status_code == 200:
                      full_text = resp.json()["candidates"][0]["content"]["parts"][0]["text"]
                      print("ðŸ”¥ Content Generated!")
                      break # Exit loop only on success
                  
                  elif resp.status_code in [429, 503, 500]:
                      print(f"â³ API Busy (Status {resp.status_code}). Sleeping for 60s...")
                      time.sleep(60) # Wait 1 minute and retry
                      continue
                  
                  else:
                      print(f"âš ï¸ Fatal Error {resp.status_code}: {resp.text}")
                      # For fatal errors (like 400 Bad Request), we must exit or it loops forever on bad data
                      raise SystemExit("Fatal API Error")
                      
              except Exception as e:
                  print(f"âš ï¸ Network Error: {e}. Retrying in 60s...")
                  time.sleep(60)
          
          if not full_text: raise SystemExit("Failed to get content from Gemini.")

          # --- 6. PARSE RESPONSE ---
          parsed = { "TITLE": "", "SLUG": "", "EXCERPT": "", "CATEGORY": "", "TAGS": "", "IMAGE_KEYWORD": "", "BODY": "" }
          
          current_section = None
          lines = full_text.splitlines()

          for line in lines:
              clean = line.strip().replace("**", "")
              if clean.startswith("TITLE:"):
                  parsed["TITLE"] = clean.replace("TITLE:", "").strip()
                  current_section = None
              elif clean.startswith("SLUG:"):
                  parsed["SLUG"] = clean.replace("SLUG:", "").strip()
                  current_section = None
              elif clean.startswith("EXCERPT:"):
                  parsed["EXCERPT"] = clean.replace("EXCERPT:", "").strip()
                  current_section = None
              elif clean.startswith("CATEGORY:"):
                  parsed["CATEGORY"] = clean.replace("CATEGORY:", "").strip()
                  current_section = None
              elif clean.startswith("TAGS:"):
                  parsed["TAGS"] = clean.replace("TAGS:", "").strip()
                  current_section = None
              elif clean.startswith("IMAGE_KEYWORD:"):
                  parsed["IMAGE_KEYWORD"] = clean.replace("IMAGE_KEYWORD:", "").strip()
                  current_section = None
              elif clean.startswith("BODY:"):
                  current_section = "BODY"
                  continue
              elif current_section == "BODY":
                  parsed["BODY"] += line + "\n"

          # Fallback Slug
          if not parsed["SLUG"]:
              parsed["SLUG"] = re.sub(r'[^a-z0-9-]', '-', parsed["TITLE"].lower()).strip('-')

          # --- 7. ASSEMBLE FILE ---
          image_url = get_real_image(parsed['IMAGE_KEYWORD'])
          authors = ["The Tea Master", "Nairobi Gossip Desk", "Bongo Flavor", "Kampala Insider"]
          
          # Clean Tags
          try:
              tags_clean = [t.strip() for t in parsed["TAGS"].strip("[]").split(',')]
          except:
              tags_clean = ["gossip", "east-africa"]

          final_file = f"""---
          title: "{parsed['TITLE'].replace('"', "'")}"
          slug: "{parsed['SLUG']}"
          excerpt: "{parsed['EXCERPT'].replace('"', "'")}"
          image: "{image_url}"
          category: "{parsed['CATEGORY']}"
          author: "{random.choice(authors)}"
          date: "{today_str}"
          tags: {json.dumps(tags_clean)}
          featured: false
          ---

          {parsed['BODY']}
          """

          import textwrap
          final_file = textwrap.dedent(final_file).strip()

          # SAVE TO ROOT: content/posts
          out_dir = os.path.join(os.getcwd(), os.environ.get("POSTS_DIR", "content/posts"))
          os.makedirs(out_dir, exist_ok=True)
          
          with open(os.path.join(out_dir, f"{parsed['SLUG']}.md"), "w", encoding="utf-8") as f:
              f.write(final_file)
          
          print(f"âœ… Success! Created {parsed['SLUG']}.md")
          EOF

      - name: Commit and push article
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "content: fresh tea served â˜• (${{ github.run_id }})"
          branch: ${{ env.DEFAULT_BRANCH }}
          file_pattern: ${{ env.POSTS_DIR }}/*.md
          commit_user_name: "Content Bot"
          commit_user_email: "actions@github.com"
        env:
          GITHUB_TOKEN: ${{ secrets.PERSONAL_GITHUB_TOKEN }}
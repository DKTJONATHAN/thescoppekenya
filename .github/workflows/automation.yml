- name: Generate article with Gemini
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          UNSPLASH_ACCESS_KEY: ${{ secrets.UNSPLASH_ACCESS_KEY }}
          MANUAL_TOPIC: ${{ inputs.manual_topic }}
          POSTS_DIR: ${{ env.POSTS_DIR }}
        run: |
          python << 'EOF'
          import os, json, datetime, requests, re, random, time
          from google import genai
          from google.genai import types

          # --- CONFIGURATION ---
          today_str = datetime.datetime.utcnow().strftime("%Y-%m-%d")
          full_date_str = datetime.datetime.utcnow().strftime("%A, %B %d, %Y")
          current_hour = datetime.datetime.utcnow().hour

          # --- 1. COUNTRY ROTATION ---
          if current_hour < 2:   country_name = 'Tanzania'
          elif current_hour < 6: country_name = 'Kenya'
          elif current_hour < 10: country_name = 'Uganda'
          elif current_hour < 14: country_name = 'Tanzania'
          elif current_hour < 18: country_name = 'Kenya'
          else:                   country_name = 'Uganda'

          # --- 2. SOURCE FILTERING (The "Cool" Part) ---
          # We force Gemini to only look at these high-authority local sites
          source_map = {
              "Kenya": "site:nation.africa OR site:standardmedia.co.ke OR site:the-star.co.ke OR site:tuko.co.ke OR site:pulselive.co.ke OR site:mpasho.co.ke OR site:nairobiwire.com",
              "Tanzania": "site:dailynews.co.tz OR site:thecitizen.co.tz OR site:mwananchi.co.tz OR site:millardayo.com OR site:bongofive.com OR site:thechanzo.com",
              "Uganda": "site:monitor.co.ug OR site:newvision.co.ug OR site:nilepost.co.ug OR site:chimpreports.com OR site:kfm.co.ug OR site:pulse.ug"
          }
          local_sources = source_map.get(country_name, "")

          # --- 3. TOPIC SELECTION ---
          manual_input = os.environ.get('MANUAL_TOPIC', '').strip()
          categories = ["Entertainment", "Sports", "Politics", "Business", "Lifestyle"]
          topic = manual_input if manual_input else random.choice(categories)

          # --- 4. PROMPT (Refined for News Grounding) ---
          spec_text = f"""
          Today's Date: {full_date_str}
          Country: {country_name}
          Topic: {topic}
          Search Filter: {local_sources}

          INSTRUCTIONS:
          1. Use the Google Search tool to find the most RECENT and TRENDING gossip or news.
          2. Focus ONLY on stories from the last 24 hours in {country_name}.
          3. Your search query should be: "trending {topic} news {country_name} {local_sources}"
          4. Act as 'The Tea Master'. Use heavy East African slang (Wueh, Kwani, Tea, Sasa Basi).
          5. Make it spicy, opinionated, and highly engaging for a social media audience.

          *** STRICT OUTPUT FORMAT ***
          TITLE: [Punchy clickbait]
          SLUG: [url-friendly-slug]
          EXCERPT: [One spicy sentence hook]
          CATEGORY: {topic}
          TAGS: [tag1, tag2, tag3]
          IMAGE_KEYWORD: [Specific visual search term]
          BODY:
          [Full article with ## Headers. Start with a bang!]
          """

          api_key = os.environ.get("GEMINI_API_KEY")
          client = genai.Client(api_key=api_key)

          # Use Search Grounding with Temperature 1.0 for more "creative/spicy" writing
          config = types.GenerateContentConfig(
              tools=[types.Tool(google_search=types.GoogleSearch())],
              temperature=1.0 
          )

          print(f"☕ Serving tea for {country_name} on {topic}...")
          
          try:
              response = client.models.generate_content(
                  model="gemini-3-flash-preview",
                  contents=spec_text,
                  config=config
              )
              full_text = response.text
          except Exception as e:
              print(f"❌ Error: {e}")
              raise SystemExit(1)

          # --- 5. PARSING & IMAGE FETCHING (Existing logic remains) ---
          # [Previous logic for parsing, get_real_image, and saving the file remains the same]
          # ... (Keeping your existing logic to ensure no breaking changes) ...
          EOF
name: East Africa Gossip Bot (Final Fix)

on:
  schedule:
    # --- EXACT EAT TIMES (Converted to UTC) ---
    - cron: '0 0 * * *'   # 3:00 AM EAT
    - cron: '0 4 * * *'   # 7:00 AM EAT
    - cron: '0 8 * * *'   # 11:00 AM EAT
    - cron: '0 12 * * *'  # 3:00 PM EAT
    - cron: '0 16 * * *'  # 7:00 PM EAT
    - cron: '0 20 * * *'  # 11:00 PM EAT

  workflow_dispatch:
    inputs:
      manual_topic:
        description: 'Force a topic (optional)'
        required: false
        default: ''

permissions:
  contents: write

env:
  DEFAULT_BRANCH: main
  POSTS_DIR: content/posts

jobs:
  generate-and-publish:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          ref: ${{ env.DEFAULT_BRANCH }}
          token: ${{ secrets.PERSONAL_GITHUB_TOKEN }}
          persist-credentials: true

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests python-slugify

      - name: Generate article with Gemini
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          UNSPLASH_ACCESS_KEY: ${{ secrets.UNSPLASH_ACCESS_KEY }}
          MANUAL_TOPIC: ${{ inputs.manual_topic }}
        run: |
          python << 'EOF'
          import os, json, datetime, requests, random, time, re
          from slugify import slugify

          # --- CONFIGURATION ---
          today_str = datetime.datetime.utcnow().strftime("%Y-%m-%d")
          full_date_str = datetime.datetime.utcnow().strftime("%A, %B %d, %Y")
          current_hour = datetime.datetime.utcnow().hour
          
          api_key = os.environ.get("GEMINI_API_KEY")
          if not api_key: raise SystemExit("Missing GEMINI_API_KEY")

          # --- 1. COUNTRY ROTATION (Synced to exact hours) ---
          if current_hour < 2: 
              country_name = 'Tanzania' # 3 AM EAT
          elif current_hour < 6: 
              country_name = 'Kenya'    # 7 AM EAT
          elif current_hour < 10: 
              country_name = 'Uganda'   # 11 AM EAT
          elif current_hour < 14: 
              country_name = 'Tanzania' # 3 PM EAT
          elif current_hour < 18: 
              country_name = 'Kenya'    # 7 PM EAT
          else: 
              country_name = 'Uganda'   # 11 PM EAT

          # --- 2. DYNAMIC TOPIC PICKER ---
          categories = ["Entertainment", "Sports", "Politics", "Business", "Technology"]
          
          manual_input = os.environ.get('MANUAL_TOPIC', '').strip()
          
          if manual_input:
              search_query = f"{manual_input} news {country_name} {today_str}"
              selected_category = "Manual"
              print(f"üéØ Manual Topic: {manual_input}")
          else:
              selected_category = random.choice(categories)
              search_query = f"trending {selected_category} news in {country_name} today {full_date_str}"
              print(f"üåç Searching for: [{selected_category}] in [{country_name}] (Hour: {current_hour} UTC)")

          # --- 3. JSON CLEANER ---
          def clean_json(text):
              text = re.sub(r'```json\s*', '', text)
              text = re.sub(r'```', '', text)
              return text.strip()

          # --- 4. IMAGE HELPER ---
          def get_real_image(query):
              access_key = os.environ.get("UNSPLASH_ACCESS_KEY")
              fallback = "https://images.unsplash.com/photo-1504711434969-e33886168f5c?w=800"
              if not access_key: return fallback
              try:
                  url = f"https://api.unsplash.com/photos/random?query={query}&orientation=landscape&client_id={access_key}"
                  resp = requests.get(url, timeout=10)
                  if resp.status_code == 200:
                      return resp.json()['urls']['regular']
              except: pass
              return fallback

          # --- 5. THE "YAPPER" PROMPT ---
          prompt = f"""
          Current Date: {full_date_str}
          Search Query: "{search_query}"
          Category: {selected_category}

          ROLE: You are "The Tea Master", East Africa's sharpest gossip blogger.
          
          TASK: 
          1. Use Google Search to find the HOTTEST story for the selected category & date.
          2. Write a blog post about it.

          TONE ADAPTATION:
          - If {selected_category} == "Politics": Focus on SCANDAL/DRAMA. Ignore boring bills.
          - If {selected_category} == "Sports": Write like a DIE-HARD FAN.
          - If {selected_category} == "Business": Focus on MONEY GOSSIP.
          - General: Use slang ("Wueh!", "Imagine!", "Tea", "Kwani?").

          STRICT CONTENT RULES:
          - MUST be a real story from TODAY or YESTERDAY.
          - MUST mention real names, locations, and quotes.

          OUTPUT FORMAT (JSON ONLY):
          {{
            "title": "A viral, clickbait title (Max 12 words)",
            "slug": "url-friendly-slug",
            "excerpt": "A single, spicy sentence hook.",
            "category": "{selected_category}",
            "tags": ["tag1", "tag2", "tag3"],
            "image_keyword": "Specific visual search term",
            "body": "The article body in Markdown. Use ## Subheadings. Keep it punchy."
          }}
          """

          # --- 6. RAW API CALL (Replaces SDK) ---
          
          url = f"https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key={api_key}"
          
          headers = { "Content-Type": "application/json" }
          
          # FIX: 'mode' must be 'MODE_DYNAMIC' (Uppercase Enum), not 'dynamic'
          payload = {
              "contents": [{ "parts": [{"text": prompt}] }],
              "tools": [{
                  "googleSearchRetrieval": {
                      "dynamicRetrievalConfig": {
                          "mode": "MODE_DYNAMIC", 
                          "dynamicThreshold": 0.3
                      }
                  }
              }],
              "safetySettings": [
                  {"category": "HARM_CATEGORY_HARASSMENT", "threshold": "BLOCK_NONE"},
                  {"category": "HARM_CATEGORY_HATE_SPEECH", "threshold": "BLOCK_NONE"},
                  {"category": "HARM_CATEGORY_SEXUALLY_EXPLICIT", "threshold": "BLOCK_NONE"},
                  {"category": "HARM_CATEGORY_DANGEROUS_CONTENT", "threshold": "BLOCK_NONE"}
              ],
              "generationConfig": { "response_mime_type": "application/json" }
          }

          parsed = None
          max_retries = 3

          for attempt in range(max_retries):
              print(f"ü§ñ Attempt {attempt+1}...")
              try:
                  resp = requests.post(url, headers=headers, json=payload, timeout=60)
                  
                  if resp.status_code != 200:
                      print(f"‚ö†Ô∏è API Error {resp.status_code}: {resp.text}")
                      time.sleep(10)
                      continue
                      
                  data = resp.json()
                  
                  # Extract text from raw JSON response
                  raw_text = data["candidates"][0]["content"]["parts"][0]["text"]
                  clean_text = clean_json(raw_text)
                  parsed = json.loads(clean_text)
                  
                  if "buzzing today" in parsed['title'].lower():
                      raise ValueError("Generic title detected, retrying...")
                      
                  print(f"üî• Success! Story: {parsed['title']}")
                  break 
                  
              except Exception as e:
                  print(f"‚ö†Ô∏è Exception: {e}")
                  time.sleep(10)
                  continue

          if not parsed:
              print("‚ùå All attempts failed. Exiting.")
              exit(1)

          # --- 7. ASSEMBLE FRONT MATTER ---
          image_url = get_real_image(parsed['image_keyword'])
          authors = ["The Tea Master", "Nairobi Gossip Desk", "Bongo Flavor", "Kampala Insider"]
          
          final_file = f"""---
          title: "{parsed['title']}"
          slug: "{parsed['slug']}"
          excerpt: "{parsed['excerpt']}"
          image: "{image_url}"
          category: "{parsed['category']}"
          author: "{random.choice(authors)}"
          date: "{today_str}"
          tags: {json.dumps(parsed['tags'])}
          featured: false
          ---

          {parsed['body']}
          """

          import textwrap
          final_file = textwrap.dedent(final_file).strip()
          
          out_dir = os.path.join(os.getcwd(), os.environ.get("POSTS_DIR", "content/posts"))
          os.makedirs(out_dir, exist_ok=True)
          
          filename = f"{parsed['slug']}.md"
          filepath = os.path.join(out_dir, filename)
          
          with open(filepath, "w", encoding="utf-8") as f:
              f.write(final_file)
          
          print(f"‚úÖ Created File: {filepath}")
          EOF

      # --- VERIFICATION STEP ---
      - name: Check File Generation
        run: |
          if [ -z "$(ls -A content/posts/*.md 2>/dev/null)" ]; then
             echo "‚ùå No posts generated!"
             exit 1
          else
             echo "‚úÖ Posts found:"
             ls content/posts/*.md
          fi

      # --- MANUAL GIT COMMIT ---
      - name: Commit and Push
        run: |
          git config --global user.name "Gossip Bot"
          git config --global user.email "bot@thescoppekenya.com"
          
          git add content/posts/*.md
          
          if git diff-index --quiet HEAD; then
            echo "‚ö†Ô∏è No changes to commit."
            exit 1 
          else
            git commit -m "üî• New Tea Served: $(date)"
            git push
          fi
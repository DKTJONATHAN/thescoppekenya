name: East Africa Gossip Bot (Gemini 3 Pro)

on:
  schedule:
    # Runs 6 times a day (Every 4 hours starting at 4 AM EAT)
    - cron: '0 1 * * *'   # 1. Kenya
    - cron: '0 5 * * *'   # 2. Uganda
    - cron: '0 9 * * *'   # 3. Tanzania
    - cron: '0 13 * * *'  # 4. Kenya
    - cron: '0 17 * * *'  # 5. Uganda
    - cron: '0 21 * * *'  # 6. Tanzania
  workflow_dispatch:
    inputs:
      manual_topic:
        description: 'Force a topic (optional)'
        required: false
        default: ''

permissions:
  contents: write

env:
  DEFAULT_BRANCH: main
  POSTS_DIR: content/posts

jobs:
  generate-and-publish:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          ref: ${{ env.DEFAULT_BRANCH }}
          token: ${{ secrets.PERSONAL_GITHUB_TOKEN }}
          persist-credentials: true

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          # We use the standard google-generativeai library which supports Gemini 3
          pip install requests google-generativeai python-slugify

      - name: Generate article with Gemini 3 Pro
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          UNSPLASH_ACCESS_KEY: ${{ secrets.UNSPLASH_ACCESS_KEY }}
          MANUAL_TOPIC: ${{ inputs.manual_topic }}
        run: |
          python << 'EOF'
          import os, json, datetime, requests, random, time
          import google.generativeai as genai
          from slugify import slugify

          # --- CONFIGURATION ---
          date_str = datetime.datetime.utcnow().strftime("%Y-%m-%d")
          current_hour = datetime.datetime.utcnow().hour
          
          # Configure Gemini SDK
          api_key = os.environ.get("GEMINI_API_KEY")
          if not api_key: raise SystemExit("Missing GEMINI_API_KEY")
          
          genai.configure(api_key=api_key)

          # --- 1. COUNTRY ROTATION LOGIC ---
          if current_hour < 4:
              country_name = 'Kenya'
          elif current_hour < 8:
              country_name = 'Uganda'
          elif current_hour < 12:
              country_name = 'Tanzania'
          elif current_hour < 16:
              country_name = 'Kenya'
          elif current_hour < 20:
              country_name = 'Uganda'
          else:
              country_name = 'Tanzania'

          # Check for manual input
          manual_input = os.environ.get('MANUAL_TOPIC', '').strip()
          
          if manual_input:
              topic_instruction = f"The user explicitly wants you to talk about: {manual_input}."
              print(f"ðŸŽ¯ Manual Topic: {manual_input}")
          else:
              topic_instruction = f"Search for the absolute trending entertainment/gossip stories in {country_name} TODAY. Pick the juiciest one."
              print(f"ðŸŒ Target Region: {country_name}")

          # --- 2. IMAGE HELPER ---
          def get_real_image(query):
              access_key = os.environ.get("UNSPLASH_ACCESS_KEY")
              fallback = "https://images.unsplash.com/photo-1504711434969-e33886168f5c?w=800"
              if not access_key: return fallback
              try:
                  url = f"https://api.unsplash.com/photos/random?query={query}&orientation=landscape&client_id={access_key}"
                  resp = requests.get(url, timeout=10)
                  if resp.status_code == 200:
                      return resp.json()['urls']['regular']
              except: pass
              return fallback

          # --- 3. THE "YAPPER" PROMPT ---
          prompt = f"""
          {topic_instruction}

          ROLE: You are a chaotic, funny East African gossip blogger. 
          
          TASK: 
          1. Use Google Search to find the real details of this story.
          2. Write a blog post about it.

          TONE GUIDE:
          - Use slang ("Wueh!", "Tea", "Imagine", "Eish!").
          - Be opinionated. If it's a scandal, drag them. If it's success, hype them.
          - NO boring politics (Parliament bills, taxes) unless it's a scandal.
          - NO robotic intros ("In the digital age..."). Start with the drama!

          OUTPUT FORMAT:
          Return strictly valid JSON with these fields:
          {{
            "title": "A short, clickbaity title",
            "slug": "url-friendly-slug",
            "excerpt": "One spicy sentence summary",
            "category": "Choose one: [Entertainment, Business, Sports, Technology, Relationships]",
            "tags": ["tag1", "tag2"],
            "image_keyword": "A single search term for the header image",
            "body": "The full article content in Markdown format..."
          }}
          """

          # --- 4. CALL GEMINI 3 PRO (With Fallback) ---
          
          # Enable Google Search Tool configuration
          tools = [
              {'google_search_retrieval': {
                  'dynamic_retrieval_config': {
                      'mode': 'dynamic',
                      'dynamic_threshold': 0.3
                  }
              }}
          ]

          # Try Gemini 3 Pro first, then 3 Flash
          models_to_try = ['gemini-3-pro-preview', 'gemini-3-flash-preview']
          
          parsed = None
          
          for model_name in models_to_try:
              print(f"ðŸ¤– Attempting with model: {model_name}...")
              try:
                  model = genai.GenerativeModel(model_name)
                  
                  response = model.generate_content(
                      prompt,
                      tools=tools,
                      generation_config=genai.types.GenerationConfig(
                          response_mime_type="application/json"
                      )
                  )
                  
                  parsed = json.loads(response.text)
                  print(f"ðŸ”¥ Success! Story Generated: {parsed['title']}")
                  break # Stop if successful
                  
              except Exception as e:
                  print(f"âš ï¸ {model_name} failed: {e}")
                  continue # Try next model

          if not parsed:
              raise SystemExit("âŒ All models failed to generate content.")

          # --- 5. ASSEMBLE FRONT MATTER ---
          image_url = get_real_image(parsed['image_keyword'])
          
          authors = ["The Tea Master", "Nairobi Gossip Desk", "Bongo Flavor", "Kampala Insider"]
          
          final_file = f"""---
          title: "{parsed['title']}"
          slug: "{parsed['slug']}"
          excerpt: "{parsed['excerpt']}"
          image: "{image_url}"
          category: "{parsed['category']}"
          author: "{random.choice(authors)}"
          date: "{date_str}"
          tags: {json.dumps(parsed['tags'])}
          featured: false
          ---

          {parsed['body']}
          """

          # Save File
          import textwrap
          final_file = textwrap.dedent(final_file).strip()
          
          out_dir = os.path.join(os.getcwd(), os.environ.get("POSTS_DIR", "content/posts"))
          os.makedirs(out_dir, exist_ok=True)
          
          filename = f"{parsed['slug']}.md"
          filepath = os.path.join(out_dir, filename)
          
          with open(filepath, "w", encoding="utf-8") as f:
              f.write(final_file)
          
          print(f"âœ… Published: {filepath}")
          EOF

      - name: Commit and push article
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "content: fresh tea served â˜• (${{ github.run_id }})"
          branch: ${{ env.DEFAULT_BRANCH }}
          file_pattern: ${{ env.POSTS_DIR }}/*.md
          commit_user_name: "Gossip Bot"
          commit_user_email: "actions@github.com"
        env:
          GITHUB_TOKEN: ${{ secrets.PERSONAL_GITHUB_TOKEN }}
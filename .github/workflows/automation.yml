name: International Gossip Bot (NewsAPI + Gemini)

on:
  schedule:
    - cron: '30 1 * * *'  # 4:30AM EAT (Celebrity)
    - cron: '30 5 * * *'  # 8:30AM EAT (Sports)
    - cron: '30 10 * * *' # 1:30PM EAT (Tech)
    - cron: '30 13 * * *' # 4:30PM EAT (Politics)
    - cron: '30 17 * * *' # 8:30PM EAT (Celebrity)
    - cron: '30 21 * * *' # 12:30AM EAT (Sports)
  workflow_dispatch:
    inputs:
      manual_topic:
        description: 'Force topic: celebrity, sports, technology, politics'
        required: false
        default: ''

permissions:
  contents: write

env:
  DEFAULT_BRANCH: main
  POSTS_DIR: content/posts

jobs:
  generate-and-publish:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          ref: ${{ env.DEFAULT_BRANCH }}
          token: ${{ secrets.PERSONAL_GITHUB_TOKEN || secrets.GITHUB_TOKEN }}
          persist-credentials: true

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests google-genai

      - name: Generate article with Gemini
        env:
          GEMINI_WRITE_KEY: ${{ secrets.GEMINI_WRITE_KEY }}
          NEWSAPI_KEY: ${{ secrets.NEWSAPI_KEY }}
          UNSPLASH_ACCESS_KEY: ${{ secrets.UNSPLASH_ACCESS_KEY }}
          MANUAL_TOPIC: ${{ inputs.manual_topic }}
          POSTS_DIR: ${{ env.POSTS_DIR }}
        run: |
          python << 'EOF'
          import os, json, datetime, requests, re, random, time
          from google import genai
          from google.genai import types

          # --- 1. CONFIGURATION ---
          today_str = datetime.datetime.utcnow().strftime("%Y-%m-%d")
          full_date_str = datetime.datetime.utcnow().strftime("%A, %B %d, %Y")
          current_hour = datetime.datetime.utcnow().hour

          # Topic rotation
          manual_input = os.environ.get('MANUAL_TOPIC', '').strip().lower()
          if manual_input in ['celebrity', 'sports', 'technology', 'politics']:
              topic = manual_input
          else:
              hour_mod = current_hour % 6
              topics = ['celebrity', 'sports', 'technology', 'politics', 'celebrity', 'sports']
              if hour_mod < len(topics):
                  topic = topics[hour_mod]
              else:
                  topic = 'celebrity'
          
          cat_map = {'celebrity': 'entertainment', 'sports': 'sports', 'technology': 'technology', 'politics': 'general'}
          newsapi_cat = cat_map.get(topic, 'general')
          
          print(f"ðŸŽ¯ Topic: {topic} | NewsAPI: {newsapi_cat}")

          # --- 2. FETCH INTERNATIONAL NEWS ---
          params = {
              'category': newsapi_cat,
              'language': 'en',
              'pageSize': 5,
              'apiKey': os.environ['NEWSAPI_KEY']
          }
          try:
              news_resp = requests.get('https://newsapi.org/v2/top-headlines', params=params, timeout=10)
              news_data = news_resp.json()
          except Exception as e:
              print(f"Error fetching news: {e}")
              exit(0)
          
          if news_data.get('totalResults', 0) == 0:
              print("No fresh news, skipping")
              exit(0)
          
          # Freshest story
          top_story = min(news_data['articles'], key=lambda x: x['publishedAt'] if x['publishedAt'] else '9999')
          title = top_story['title']
          snippet = (top_story.get('description') or top_story.get('content', ''))[:300]
          source = top_story['source']['name']
          pub_date = top_story['publishedAt']
          
          print(f"ðŸ“° Headline: {title[:80]}... ({source})")

          # --- 3. IMAGE HELPER ---
          def get_real_image(query):
              access_key = os.environ.get("UNSPLASH_ACCESS_KEY")
              fallback_image = "https://images.unsplash.com/photo-1504711434969-e33886168f5c?w=1200"
              if not access_key: return fallback_image
              url = f"https://api.unsplash.com/photos/random?query={query}&orientation=landscape&client_id={access_key}"
              try:
                  resp = requests.get(url, timeout=10)
                  if resp.status_code == 200:
                      return resp.json()['urls']['regular']
              except Exception: pass
              return fallback_image

          # --- 4. GOSSIP-TONE PROMPT ---
          gossip_angles = [
              "The celebrity meltdown nobody saw coming",
              "Sports star's biggest scandal exposed",
              "Tech giant's dirty secret revealed", 
              "Politician caught in ultimate hypocrisy"
          ]
          
          angle_index = 0
          if topic == 'celebrity': angle_index = 0
          elif topic == 'sports': angle_index = 1
          elif topic == 'technology': angle_index = 2
          elif topic == 'politics': angle_index = 3
          
          angle = gossip_angles[angle_index]
          
          prompt = f'''Current Date: {full_date_str}
          NEWS STORY:
          Title: "{title}"
          Snippet: "{snippet}"
          Source: {source}
          Date: {pub_date}

          ROLE: "Global Tea Spiller" - International gossip blogger (jonathanmwaniki.co.ke style).

          TASK: Turn these FACTS into savage gossip. BRUTAL opinions OK after facts established.
          - Start factual (what snippet says).
          - Then savage analysis ("This proves X is washed", "Career over", etc.).
          - Mention 2-3 celeb equivalents (Taylor Swift drama, Messi fumble).
          - Heavy slang: "Spill the tea", "Career suicide", "Public execution".

          STRICT OUTPUT FORMAT:
          TITLE: [Savage clickbait, mention name if possible]
          SLUG: [url-friendly-lowercase-no-dates]
          EXCERPT: [One-line spicy hook]
          CATEGORY: {topic.capitalize()}
          TAGS: [gossip, {topic}, scandal, drama]
          IMAGE_KEYWORD: [{topic} celebrity drama]
          BODY:
          [1400 words. ## Headers: The Incident, What Really Happened, Public Reaction, Career Fallout]

          RULES:
          - UK English. Commas, NO em-dashes (â€”/â€“).
          - Grounded in THIS headline. No hallucinations.
          - Dramatic but readable (8th grade level).'''

          # --- 5. GEMINI CALL (With Retry Logic) ---
          client = genai.Client(api_key=os.environ.get("GEMINI_WRITE_KEY"))
          model_id = "gemini-3-flash-preview"

          print(f"ðŸ¤– Spilling tea with {model_id}...")
          
          full_text = ""
          max_retries = 3
          
          for attempt in range(max_retries):
              try:
                  response = client.models.generate_content(
                      model=model_id,
                      contents=prompt,
                      config=types.GenerateContentConfig(
                          temperature=0.7
                      )
                  )
                  full_text = response.text.strip()
                  print("âœ… Generation successful!")
                  break # Success, exit loop
              except Exception as e:
                  print(f"âš ï¸ Attempt {attempt + 1} failed: {e}")
                  if attempt < max_retries - 1:
                      print("â³ Retrying in 5 seconds...")
                      time.sleep(5)
                  else:
                      print("âŒ All retries failed.")
                      exit(1)

          # --- 6. PARSE & DASH SCRUB ---
          parsed = { "TITLE": "", "SLUG": "", "EXCERPT": "", "CATEGORY": "", "TAGS": "", "IMAGE_KEYWORD": "", "BODY": "" }
          current_section = None
          
          for line in full_text.splitlines():
              clean = line.strip().replace("**", "")
              if clean.startswith("TITLE:"): parsed["TITLE"] = clean.replace("TITLE:", "").strip()
              elif clean.startswith("SLUG:"): parsed["SLUG"] = clean.replace("SLUG:", "").strip()
              elif clean.startswith("EXCERPT:"): parsed["EXCERPT"] = clean.replace("EXCERPT:", "").strip()
              elif clean.startswith("CATEGORY:"): parsed["CATEGORY"] = clean.replace("CATEGORY:", "").strip()
              elif clean.startswith("TAGS:"): parsed["TAGS"] = clean.replace("TAGS:", "").strip()
              elif clean.startswith("IMAGE_KEYWORD:"): parsed["IMAGE_KEYWORD"] = clean.replace("IMAGE_KEYWORD:", "").strip()
              elif clean.startswith("BODY:"):
                  current_section = "BODY"
                  continue
              elif current_section == "BODY":
                  parsed["BODY"] += line + "\n"

          # Em-dash scrubber
          for key in ["TITLE", "EXCERPT", "BODY"]:
              text = parsed[key]
              text = text.replace("â€”", ", ").replace("â€“", ", ").replace("--", ", ")
              text = re.sub(r',\s*,', ',', text)
              parsed[key] = text.strip()

          # Fallbacks
          if not parsed["TITLE"]: parsed["TITLE"] = f"{topic.capitalize()} Tea Spill"
          if not parsed["SLUG"]: 
              parsed["SLUG"] = re.sub(r'[^a-z0-9-]', '-', title.lower())[:80].strip('-')

          # --- 7. SAVE ---
          image_url = get_real_image(parsed['IMAGE_KEYWORD'])
          
          import textwrap
          final_file = f"""---
          title: "{parsed['TITLE'].replace('"', "'")}"
          slug: "{parsed['SLUG']}"
          excerpt: "{parsed['EXCERPT'].replace('"', "'")}"
          image: "{image_url}"
          category: "{parsed['CATEGORY']}"
          date: "{today_str}"
          ---

          {parsed['BODY']}
          """
          
          final_file = textwrap.dedent(final_file).strip()

          out_dir = os.path.join(os.getcwd(), os.environ.get("POSTS_DIR", "content/posts"))
          os.makedirs(out_dir, exist_ok=True)
          with open(os.path.join(out_dir, f"{parsed['SLUG']}.md"), "w", encoding="utf-8") as f:
              f.write(final_file)
          
          print(f"âœ… Tea spilled: {parsed['SLUG']}.md")
          EOF

      - name: Commit and push article
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "content: fresh international tea â˜•"
          branch: ${{ env.DEFAULT_BRANCH }}
          file_pattern: ${{ env.POSTS_DIR }}/*.md
          commit_user_name: "Content Bot"
          commit_user_email: "actions@github.com"
        env:
          GITHUB_TOKEN: ${{ secrets.PERSONAL_GITHUB_TOKEN || secrets.GITHUB_TOKEN }}
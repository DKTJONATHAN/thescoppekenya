name: "Instant Post to X on Publish"

on:
  push:
    paths:
      - 'content/posts/**.md'
      - 'content/posts/**.mdx'
  workflow_dispatch:
    inputs:
      specific_slug:
        description: 'Slug of the post (e.g., "my-new-article")'
        required: false
        type: string

jobs:
  tweet:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install tweepy requests

      - name: Wait for Deployment
        if: github.event_name == 'push'
        run: |
          echo "Waiting 30 seconds for site to build..."
          sleep 30

      - name: Detect and Tweet
        env:
          APP_KEY: ${{ secrets.TWITTER_CONSUMER_KEY }}
          APP_SECRET: ${{ secrets.TWITTER_CONSUMER_SECRET }}
          ACCESS_TOKEN: ${{ secrets.TWITTER_ACCESS_TOKEN }}
          ACCESS_SECRET: ${{ secrets.TWITTER_ACCESS_TOKEN_SECRET }}
          INPUT_SLUG: ${{ inputs.specific_slug }}
        run: |
          # Disable GitHub strict crash rule
          set +e 

          if [ -z "$APP_KEY" ] || [ -z "$ACCESS_TOKEN" ]; then
            echo "Warning: Twitter credentials not set, skipping"
            exit 0
          fi

          SITE_URL="https://thescoopkenya.vercel.app"

          # 1. Determine which file to process based on manual input or git diff
          if [ -n "$INPUT_SLUG" ]; then
            FILE=$(find content/posts -name "${INPUT_SLUG}.md*" | head -n 1)
            CHANGED="$FILE"
          else
            CHANGED=$(git diff --name-only --diff-filter=AM HEAD~1 HEAD | grep '^content/posts/' || true)
            
            # Fallback for manual runs without an input slug
            if [ -z "$CHANGED" ] && [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
              CHANGED=$(find content/posts -type f \( -name "*.md" -o -name "*.mdx" \) -exec stat -c "%Y %n" {} + | sort -nr | head -n 1 | cut -d' ' -f2- || true)
              echo "Manual run detected. Defaulting to most recent file."
            fi
          fi

          if [ -z "$CHANGED" ]; then
            echo "No post changes detected"
            exit 0
          fi

          # 2. PREPARE PYTHON SCRIPT
          cat << 'EOF' > tweet.py
import os, sys, tweepy

api_key = os.environ.get("APP_KEY")
api_secret = os.environ.get("APP_SECRET")
access_token = os.environ.get("ACCESS_TOKEN")
access_secret = os.environ.get("ACCESS_SECRET")

title = os.environ.get("TWEET_TITLE", "").strip()
description = os.environ.get("TWEET_DESCRIPTION", "").strip()
url = os.environ.get("TWEET_URL")
image_path = os.environ.get("TWEET_IMAGE")

# Safely calculate Twitter 280 character limit
available_space = 280 - len(title) - 2

if available_space > 0:
    if len(description) > available_space:
        description = description[:available_space - 3].rsplit(" ", 1)[0] + "..."
    tweet_text = f"{title}\n\n{description}"
else:
    if len(title) > 280:
        tweet_text = title[:277] + "..."
    else:
        tweet_text = title

try:
    auth = tweepy.OAuth1UserHandler(api_key, api_secret, access_token, access_secret)
    api = tweepy.API(auth)
    
    client = tweepy.Client(
        consumer_key=api_key, consumer_secret=api_secret,
        access_token=access_token, access_token_secret=access_secret
    )

    media_id = None
    if image_path and os.path.exists(image_path):
        print("Uploading media to Twitter...")
        media = api.media_upload(image_path)
        media_id = media.media_id

    print("Sending main tweet...")
    if media_id:
        response = client.create_tweet(text=tweet_text, media_ids=[media_id])
    else:
        response = client.create_tweet(text=tweet_text)
        
    tweet_id = response.data["id"]
    print(f"Main tweet posted successfully! Tweet ID: {tweet_id}")
    
    print("Adding reply with the article link...")
    reply_text = f"Read the full story here: {url}"
    client.create_tweet(text=reply_text, in_reply_to_tweet_id=tweet_id)
    print("Link reply posted successfully!")
    
except Exception as e:
    print(f"Twitter API Error: {e}")
    sys.exit(1)
EOF

          # 3. Process and post each changed file sequentially
          while IFS= read -r file; do
            if [ ! -f "$file" ]; then continue; fi
            
            FILENAME=$(basename "$file")
            SLUG="${FILENAME%.*}"
            URL="${SITE_URL}/article/${SLUG}"
            
            echo "Processing File: $file"
            
            TITLE=$(grep -m 1 "^title:" "$file" | cut -d: -f2- | tr -d '"' | tr -d "'" | sed 's/^ *//' || true)
            IMAGE_URL=$(grep -m 1 "^image:" "$file" | cut -d: -f2- | tr -d '"' | tr -d "'" | sed 's/^ *//' || true)
            
            DESCRIPTION=$(awk 'BEGIN {count=0; body=0} /^---$/ {count++; if(count==2){body=1; next}} body==1 {print}' "$file" | awk -v RS='' -v ORS='\n\n' 'NR<=1' || true)
            
            if [ -z "$TITLE" ]; then TITLE="New Article"; fi
            if [ -z "$DESCRIPTION" ]; then DESCRIPTION="Read the latest updates on our website."; fi
            
            IMAGE_PATH=""
            if [ -n "$IMAGE_URL" ]; then
              echo "Image found. Downloading locally to bypass blocks..."
              curl -s -L -A "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36" -o tw_preview_image.jpg "$IMAGE_URL" || true
              
              MIME_TYPE=$(file --mime-type -b tw_preview_image.jpg 2>/dev/null || echo "unknown")
              echo "Downloaded file type detected as: $MIME_TYPE"
              
              if [ -s "tw_preview_image.jpg" ] && [[ "$MIME_TYPE" == image/* ]]; then
                IMAGE_PATH="tw_preview_image.jpg"
                echo "Valid image confirmed."
              else
                echo "Invalid image downloaded. Proceeding with text only."
              fi
            fi

            export TWEET_TITLE="$TITLE"
            export TWEET_DESCRIPTION="$DESCRIPTION"
            export TWEET_URL="$URL"
            export TWEET_IMAGE="$IMAGE_PATH"

            python tweet.py
            
            rm -f tw_preview_image.jpg
            
          done <<< "$CHANGED"
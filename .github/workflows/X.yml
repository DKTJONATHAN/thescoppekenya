name: Auto-Tweet New Gossip

on:
  push:
    paths:
      - 'content/posts/*.md'
  workflow_dispatch:

jobs:
  tweet_article:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: pip install tweepy

      - name: Compose and Send Tweet
        env:
          TWITTER_CONSUMER_KEY: ${{ secrets.TWITTER_CONSUMER_KEY }}
          TWITTER_CONSUMER_SECRET: ${{ secrets.TWITTER_CONSUMER_SECRET }}
          TWITTER_ACCESS_TOKEN: ${{ secrets.TWITTER_ACCESS_TOKEN }}
          TWITTER_ACCESS_SECRET: ${{ secrets.TWITTER_ACCESS_SECRET }}
        run: |
          python << 'EOF'
          import os, sys, re, time, subprocess, tweepy

          consumer_key = os.environ.get('TWITTER_CONSUMER_KEY')
          consumer_secret = os.environ.get('TWITTER_CONSUMER_SECRET')
          access_token = os.environ.get('TWITTER_ACCESS_TOKEN')
          access_secret = os.environ.get('TWITTER_ACCESS_SECRET')

          if not all([consumer_key, consumer_secret, access_token, access_secret]):
              print("‚ùå Missing Twitter/X API credentials in GitHub Secrets.")
              sys.exit(1)

          # Find the newest .md file
          result = subprocess.run(['git', 'diff', '--name-only', 'HEAD\~1', 'HEAD'], capture_output=True, text=True)
          md_files = [f for f in result.stdout.splitlines() if f.startswith('content/posts/') and f.endswith('.md')]

          if not md_files:
              print("No new markdown files found.")
              sys.exit(0)

          latest_file = md_files[0]
          print(f"üìç Processing: {latest_file}")

          with open(latest_file, 'r', encoding='utf-8') as f:
              content = f.read()

          title = re.search(r'title:\s*["\'](.*?)["\']', content)
          excerpt = re.search(r'excerpt:\s*["\'](.*?)["\']', content)
          slug = re.search(r'slug:\s*["\'](.*?)["\']', content)

          title = title.group(1) if title else "New Za Ndani Story"
          excerpt = excerpt.group(1) if excerpt else ""
          slug = slug.group(1) if slug else ""

          article_link = f"https://zandani.co.ke/article/{slug}"

          print(f"Title: {title}")
          print(f"Link : {article_link}")

          # Wait for Netlify/Vercel deployment + OG image
          print("‚è≥ Waiting 45 seconds for site to go live...")
          time.sleep(45)

          client = tweepy.Client(
              consumer_key=consumer_key,
              consumer_secret=consumer_secret,
              access_token=access_token,
              access_token_secret=access_secret
          )

          tweet_text = f"{title}\n\n{excerpt}\n\nüî• Read full story:\n{article_link}\n\n#ZaNdani #KenyaGossip"

          if len(tweet_text) > 280:
              tweet_text = tweet_text[:267] + "..."

          print("üìù Tweet preview:")
          print(tweet_text)
          print(f"Length: {len(tweet_text)} characters")

          try:
              response = client.create_tweet(text=tweet_text)
              print(f"‚úÖ Tweet posted successfully! ID: {response.data['id']}")
          except tweepy.TweepyException as e:
              print(f"‚ùå X API Error: {e}")
              if hasattr(e, 'response') and e.response is not None:
                  try:
                      print("Raw X response:")
                      print(e.response.text)
                      if "403" in str(e) or "Forbidden" in str(e) or "pay" in str(e).lower():
                          print("\nüí∞ This is the 'pay to post' error.")
                          print("X now requires the **Basic** plan ($100‚Äì$200/month) to post tweets via API.")
                          print("Free tier is read-only only.")
                  except:
                      pass
              sys.exit(1)
          EOF
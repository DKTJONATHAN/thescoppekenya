name: Auto-Tweet New Gossip

on:
  push:
    paths:
      - 'content/posts/*.md'
  workflow_dispatch:

jobs:
  tweet_article:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 2 # Fetch at least 2 commits to find the diff

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: pip install tweepy requests

      - name: Compose and Send Tweet
        env:
          APP_KEY: ${{ secrets.TWITTER_CONSUMER_KEY }}
          APP_SECRET: ${{ secrets.TWITTER_CONSUMER_SECRET }}
          ACCESS_TOKEN: ${{ secrets.TWITTER_ACCESS_TOKEN }}
          ACCESS_SECRET: ${{ secrets.TWITTER_ACCESS_TOKEN_SECRET }}
        run: |
          python << 'EOF'
          import os, sys, re, requests, tweepy, subprocess

          # 1. Authenticate with X API
          api_key = os.environ.get('APP_KEY')
          api_secret = os.environ.get('APP_SECRET')
          access_token = os.environ.get('ACCESS_TOKEN')
          access_secret = os.environ.get('ACCESS_SECRET')

          if not all([api_key, api_secret, access_token, access_secret]):
              print("Error: Missing Twitter API credentials.")
              sys.exit(1)

          # 2. Find the brand new markdown file from the git commit
          result = subprocess.run(['git', 'diff', '--name-only', 'HEAD~1', 'HEAD'], capture_output=True, text=True)
          files = result.stdout.splitlines()
          md_files = [f for f in files if f.startswith('content/posts/') and f.endswith('.md')]

          if not md_files:
              print("No new markdown files found in this push. Skipping tweet.")
              sys.exit(0)

          latest_file = md_files[0]
          print(f"üìç Found new article: {latest_file}")

          # 3. Read the file and extract the juicy details
          with open(latest_file, 'r', encoding='utf-8') as f:
              content = f.read()

          try:
              title = re.search(r'title:\s*"(.*?)"', content).group(1)
              excerpt = re.search(r'excerpt:\s*"(.*?)"', content).group(1)
              slug = re.search(r'slug:\s*"(.*?)"', content).group(1)
              image_url = re.search(r'image:\s*"(.*?)"', content).group(1)
          except AttributeError:
              print("Error: Could not parse frontmatter from the markdown file.")
              sys.exit(1)

          # 4. Download the image temporarily to the GitHub runner
          image_path = "temp_gossip_img.jpg"
          media_ids = []
          if image_url:
              print(f"üì∏ Downloading image: {image_url}")
              try:
                  r = requests.get(image_url, stream=True, timeout=10)
                  if r.status_code == 200:
                      with open(image_path, 'wb') as f:
                          for chunk in r: f.write(chunk)
                  else:
                      print("Failed to download image. Proceeding without it.")
                      image_path = None
              except Exception as e:
                  print(f"Image download error: {e}")
                  image_path = None

          # 5. Connect to X (Twitter) API
          # We use API v1.1 just for the media upload (X free tier quirk)
          auth = tweepy.OAuth1UserHandler(api_key, api_secret, access_token, access_secret)
          api_v1 = tweepy.API(auth)
          
          # We use API v2 for actually composing the tweet
          client = tweepy.Client(
              consumer_key=api_key,
              consumer_secret=api_secret,
              access_token=access_token,
              access_token_secret=access_secret
          )

          # Upload the image if we successfully downloaded it
          if image_path and os.path.exists(image_path):
              print("üöÄ Uploading media to X...")
              try:
                  media = api_v1.media_upload(image_path)
                  media_ids.append(media.media_id)
              except Exception as e:
                  print(f"Media upload failed: {e}")

          # 6. Format the Tweet (Keep it under 280 characters)
          main_text = f"{title}\n\n{excerpt}"
          if len(main_text) > 270:
              main_text = main_text[:267] + "..."

          # 7. Post the Main Tweet
          print("üìù Posting main tweet...")
          try:
              response = client.create_tweet(
                  text=main_text, 
                  media_ids=media_ids if media_ids else None
              )
              tweet_id = response.data['id']
              print(f"‚úÖ Main tweet sent successfully! ID: {tweet_id}")
          except Exception as e:
              print(f"Failed to send main tweet: {e}")
              sys.exit(1)

          # 8. Post the Reply with the Link
          article_link = f"https://zandani.co.ke/posts/{slug}"
          reply_text = f"Read full article here: {article_link}"
          
          print("üîó Posting reply link...")
          try:
              client.create_tweet(
                  text=reply_text, 
                  in_reply_to_tweet_id=tweet_id
              )
              print("‚úÖ Reply sent successfully!")
          except Exception as e:
              print(f"Failed to send reply: {e}")

          EOF
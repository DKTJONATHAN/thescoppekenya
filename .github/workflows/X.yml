name: "X Auto-Post"

on:
  push:
    paths:
      - 'content/posts/**.md'
  workflow_dispatch:
    inputs:
      specific_slug:
        description: 'Slug of the post to test (e.g., "my-latest-gossip")'
        required: false
        type: string

jobs:
  post_to_x:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install tweepy requests

      - name: Wait for 30 seconds
        if: github.event_name == 'push'
        run: |
          echo "Waiting 30 seconds for The Scoop Kenya to deploy..."
          sleep 30

      - name: Publish to X
        env:
          X_API_KEY: ${{ secrets.X_API_KEY }}
          X_API_KEY_SECRET: ${{ secrets.X_API_KEY_SECRET }}
          X_ACCESS_TOKEN: ${{ secrets.X_ACCESS_TOKEN }}
          X_ACCESS_TOKEN_SECRET: ${{ secrets.X_ACCESS_TOKEN_SECRET }}
          INPUT_SLUG: ${{ inputs.specific_slug }}
        run: |
          # Prevent the script from crashing immediately if a single command fails
          set +e

          if [ -z "$X_API_KEY" ] || [ -z "$X_ACCESS_TOKEN" ]; then
            echo "Warning: X credentials not set, skipping"
            exit 0
          fi

          SITE_URL="https://thescoopkenya.vercel.app"

          # 1. Check if you manually typed a slug to test
          if [ -n "$INPUT_SLUG" ]; then
            echo "Manual input detected. Searching for $INPUT_SLUG.md..."
            CHANGED=$(find content/posts -name "${INPUT_SLUG}.md" | head -n 1)
          else
            # 2. Otherwise, look for what changed in the push
            CHANGED=$(git diff --name-only HEAD~1 HEAD -- 'content/posts/' | grep '\.md$' || true)
          fi

          if [ -z "$CHANGED" ]; then
            echo "No post changes detected"
            exit 0
          fi

          cat << 'EOF' > post_to_x.py
import sys, os, tweepy, time

client = tweepy.Client(
    consumer_key=os.environ['X_API_KEY'],
    consumer_secret=os.environ['X_API_KEY_SECRET'],
    access_token=os.environ['X_ACCESS_TOKEN'],
    access_token_secret=os.environ['X_ACCESS_TOKEN_SECRET']
)
auth = tweepy.OAuth1UserHandler(
    os.environ['X_API_KEY'], os.environ['X_API_KEY_SECRET'],
    os.environ['X_ACCESS_TOKEN'], os.environ['X_ACCESS_TOKEN_SECRET']
)
api = tweepy.API(auth)

text = os.environ.get('FINAL_MESSAGE', '')
url_text = f"Read the full story here: {os.environ['URL']}"
image_path = "x_preview_image.jpg"

max_length = 270
if len(text) > max_length:
    text = text[:max_length-3] + "..."

media_ids = []
if os.path.exists(image_path) and os.path.getsize(image_path) > 0:
    try:
        media = api.media_upload(image_path)
        media_ids.append(media.media_id)
        print("Image uploaded to X successfully.")
    except Exception as e:
        print(f"Warning: Media upload failed: {e}")

try:
    if media_ids:
        response = client.create_tweet(text=text, media_ids=media_ids)
    else:
        response = client.create_tweet(text=text)
    
    tweet_id = response.data['id']
    print(f"Main post successful for {os.environ['SLUG']}. Waiting 10 seconds to sync...")
    
    time.sleep(10)

    print("Adding link to the comment section...")
    client.create_tweet(text=url_text, in_reply_to_tweet_id=tweet_id)
    print("Successfully published post and link comment!")

except Exception as e:
    print(f"Error posting to X: {e}")
    sys.exit(1)
EOF

          while IFS= read -r file; do
            if [ ! -f "$file" ]; then continue; fi
            
            export SLUG=$(basename "$file" .md)
            export URL="${SITE_URL}/article/${SLUG}"
            
            echo "Processing File: $file"
            
            TITLE=$(grep -m 1 "^title:" "$file" | cut -d: -f2- | tr -d '"' | tr -d "'" | sed 's/^ *//' || true)
            IMAGE_URL=$(grep -m 1 "^image:" "$file" | cut -d: -f2- | tr -d '"' | tr -d "'" | sed 's/^ *//' || true)
            
            PARAGRAPH=$(awk 'BEGIN {count=0; body=0} /^---$/ {count++; if(count==2){body=1; next}} body==1 {print}' "$file" | awk -v RS='' -v ORS='\n\n' 'NR<=1' || true)
            
            if [ -z "$TITLE" ]; then TITLE="Latest Update"; fi
            
            export FINAL_MESSAGE="$TITLE

$PARAGRAPH"

            echo "Posting to X Page..."
            
            if [ -n "$IMAGE_URL" ]; then
              echo "Image found. Disguising as a web browser to download..."
              curl -s -L -A "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36" -o x_preview_image.jpg "$IMAGE_URL" || true
              
              MIME_TYPE=$(file --mime-type -b x_preview_image.jpg 2>/dev/null || echo "unknown")
              echo "Downloaded file type detected as: $MIME_TYPE"
              
              if ! [[ "$MIME_TYPE" == image/* ]]; then
                echo "Download returned an invalid file. Falling back to text-only post..."
                rm -f x_preview_image.jpg
              else
                echo "Valid image confirmed. Uploading..."
              fi
            else
              echo "No image found. Falling back to text-only post..."
            fi

            python3 post_to_x.py
            
            rm -f x_preview_image.jpg
            
          done <<< "$CHANGED"
name: East Africa (Gemini 3 Flash)

on:
  schedule:
    - cron: '0 0 * * *'   # 3 AM EAT
    - cron: '0 8 * * *'   # 11 AM EAT
    - cron: '0 16 * * *'  # 7 PM EAT
  workflow_dispatch:
    inputs:
      manual_topic:
        description: 'Force a topic (optional)'
        required: false
        default: ''

permissions:
  contents: write

env:
  DEFAULT_BRANCH: main
  POSTS_DIR: content/posts

jobs:
  generate-and-publish:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          ref: ${{ env.DEFAULT_BRANCH }}
          token: ${{ secrets.PERSONAL_GITHUB_TOKEN || secrets.GITHUB_TOKEN }}
          persist-credentials: true

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests google-genai

      - name: Generate article with Gemini
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          UNSPLASH_ACCESS_KEY: ${{ secrets.UNSPLASH_ACCESS_KEY }}
          MANUAL_TOPIC: ${{ inputs.manual_topic }}
          POSTS_DIR: ${{ env.POSTS_DIR }}
        run: |
          python << 'EOF'
          import os, json, datetime, requests, re, random, time, sys
          from google import genai
          from google.genai import types

          # --- 1. CONFIGURATION ---
          today_str = datetime.datetime.utcnow().strftime("%Y-%m-%d")
          full_date_str = datetime.datetime.utcnow().strftime("%A, %B %d, %Y")
          current_hour = datetime.datetime.utcnow().hour

          # Fallback Model List
          MODELS = ["gemini-3-flash-preview", "gemini-2.5-flash"]

          if current_hour < 2:   
              country_name, vips = 'Tanzania', "Samia Suluhu, Diamond Platnumz, Harmonize, Zuchu, Alikiba"
          elif current_hour < 10: 
              country_name, vips = 'Kenya', "William Ruto, Rigathi Gachagua, Raila Odinga, Eric Omondi, Khaligraph Jones"
          else:                   
              country_name, vips = 'Uganda', "Jose Chameleone, Eddy Kenzo, Spice Diana, Bad Black"

          manual_input = os.environ.get('MANUAL_TOPIC', '').strip()
          topic = manual_input if manual_input else random.choice(["Entertainment", "Sports", "Politics"])
          print(f"ðŸŽ¯ Target: {country_name} | Topic: {topic}")

          # --- 2. HELPERS ---
          def dash_scrubber(text):
              return text.replace('\u2014', '-').replace('\u2013', '-')

          def get_real_image(query):
              access_key = os.environ.get("UNSPLASH_ACCESS_KEY")
              fallback_image = "https://images.unsplash.com/photo-1504711434969-e33886168f5c?w=1200"
              if not access_key: return fallback_image
              url = f"https://api.unsplash.com/photos/random?query={query}&orientation=landscape&client_id={access_key}"
              try:
                  resp = requests.get(url, timeout=10)
                  if resp.status_code == 200: return resp.json()['urls']['regular']
              except: pass
              return fallback_image

          # --- 3. GENERATION WITH RETRY LOGIC ---
          client = genai.Client(api_key=os.environ.get("GEMINI_API_KEY"))
          google_search_tool = types.Tool(google_search=types.GoogleSearch())

          spec_text = f"Today: {full_date_str}. Country: {country_name}. Topic: {topic}. Target: {vips}. Use Search to find latest news. No em/en dashes. Style: Savage gossip. Format: TITLE: SLUG: EXCERPT: CATEGORY: TAGS: IMAGE_KEYWORD: BODY:"

          full_text = None
          for model_id in MODELS:
              if full_text: break
              print(f"ðŸ¤– Trying {model_id}...")
              
              for attempt in range(3): # 3 retries per model
                  try:
                      response = client.models.generate_content(
                          model=model_id,
                          contents=spec_text,
                          config=types.GenerateContentConfig(
                              temperature=1.0,
                              thinking_config=types.ThinkingConfig(thinking_level="minimal") if "3-flash" in model_id else None,
                              tools=[google_search_tool]
                          )
                      )
                      full_text = dash_scrubber(response.text.strip())
                      print(f"âœ… Success with {model_id}!")
                      break
                  except Exception as e:
                      if "429" in str(e):
                          wait_time = (2 ** attempt) * 30 + random.randint(1, 10)
                          print(f"â³ 429 Quota Hit. Waiting {wait_time}s before retry {attempt+1}/3...")
                          time.sleep(wait_time)
                      else:
                          print(f"âš ï¸ Error: {e}")
                          break

          if not full_text:
              print("âŒ All models and retries failed.")
              sys.exit(1)

          # --- 4. PARSE & SAVE ---
          parsed = { "TITLE": "N/A", "SLUG": f"tea-{random.randint(100,999)}", "EXCERPT": "", "CATEGORY": topic, "TAGS": "", "IMAGE_KEYWORD": topic, "BODY": "" }
          current_section = None
          for line in full_text.splitlines():
              clean = line.strip().replace("**", "")
              if clean.startswith("TITLE:"): parsed["TITLE"] = clean.replace("TITLE:", "").strip()
              elif clean.startswith("SLUG:"): parsed["SLUG"] = clean.replace("SLUG:", "").strip()
              elif clean.startswith("EXCERPT:"): parsed["EXCERPT"] = clean.replace("EXCERPT:", "").strip()
              elif clean.startswith("IMAGE_KEYWORD:"): parsed["IMAGE_KEYWORD"] = clean.replace("IMAGE_KEYWORD:", "").strip()
              elif clean.startswith("BODY:"):
                  current_section = "BODY"
                  continue
              elif current_section == "BODY":
                  parsed["BODY"] += line + "\n"

          image_url = get_real_image(parsed['IMAGE_KEYWORD'])
          final_file = f"---\ntitle: \"{parsed['TITLE']}\"\nslug: \"{parsed['SLUG']}\"\nexcerpt: \"{parsed['EXCERPT']}\"\nimage: \"{image_url}\"\ncategory: \"{parsed['CATEGORY']}\"\ndate: \"{today_str}\"\n---\n\n{parsed['BODY'].strip()}"

          out_dir = os.path.join(os.getcwd(), os.environ.get("POSTS_DIR", "content/posts"))
          os.makedirs(out_dir, exist_ok=True)
          with open(os.path.join(out_dir, f"{parsed['SLUG']}.md"), "w", encoding="utf-8") as f:
              f.write(final_file)
          
          print(f"âœ… Created {parsed['SLUG']}.md")
          EOF

      - name: Commit and push article
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "content: daily tea served â˜•"
          branch: ${{ env.DEFAULT_BRANCH }}
          file_pattern: ${{ env.POSTS_DIR }}/*.md
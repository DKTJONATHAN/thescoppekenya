name: East Africa Gossip Bot (Puter + Grok 4.1)

on:
  schedule:
    - cron: '0 0,4,8,12,16,20 * * *' # Every 4 hours to catch peak drama
  workflow_dispatch:
    inputs:
      manual_topic:
        description: 'Force a specific drama topic'
        required: false
        default: ''

permissions:
  contents: write

env:
  DEFAULT_BRANCH: main
  POSTS_DIR: content/posts

jobs:
  generate-and-publish:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          ref: ${{ env.DEFAULT_BRANCH }}
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm install @puter/sdk

      - name: Generate article with Grok 4.1
        env:
          MANUAL_TOPIC: ${{ github.event.inputs.manual_topic }}
        run: |
          node << 'EOF'
          const fs = require('fs');
          const path = require('path');
          const puter = require('@puter/sdk');

          async function generate() {
              const now = new Date();
              const todayStr = now.toISOString().split('T')[0];
              const hour = now.getUTCHours();

              // --- 1. RESEARCHED GOSSIP HANDLES ---
              let country, handles, vips;
              
              if (hour < 8) {
                  country = 'Kenya';
                  handles = ['kenyasgossips', 'Nairobi_Gossip', 'TukoCoKe', 'Kenyans'];
                  vips = 'William Ruto, Eric Omondi, Khaligraph Jones, Rigathi Gachagua';
              } else if (hour < 16) {
                  country = 'Tanzania';
                  handles = ['Bongo5', 'GhaflaTanzania', 'MillardAyo', 'Jaymaudaku'];
                  vips = 'Diamond Platnumz, Samia Suluhu, Harmonize, Zuchu';
              } else {
                  country = 'Uganda';
                  handles = ['MbuUganda', 'GalaxyFMUg', 'GhaflaUganda', 'sqoopuganda'];
                  vips = 'Bobi Wine, Museveni, Sheebah Karungi, Eddy Kenzo';
              }

              console.log(`üéØ Targeting ${country} via handles: ${handles.join(', ')}`);

              // --- 2. GROK 4.1 REAL-TIME GENERATION ---
              const prompt = `
                  Today's Date: ${todayStr}
                  Target Country: ${country}
                  VIPs to check: ${vips}

                  TASK: 
                  Use X Search to find a specific, text-based gossip story posted in the last 24 hours by these handles: ${handles.join(', ')}.
                  Look for "Character Development", "Tea", or "Drama".

                  STRICT CONSTRAINTS:
                  - NO em dashes (‚Äî) or en dashes (‚Äì). Use standard hyphens (-) only.
                  - Use heavy East African slang (Wueh, Imagine, Sasa basi).
                  - If handles are dry, search for trending hashtags: #KenyaGossip, #BongoDrama, #UgandaCelebs.

                  OUTPUT FORMAT:
                  TITLE: [Savage Clickbait]
                  SLUG: [url-friendly-slug]
                  EXCERPT: [Spicy hook]
                  IMAGE_KEYWORD: [Visual search term]
                  BODY:
                  [Full article in Markdown with ## Headers]
              `;

              try {
                  const response = await puter.ai.chat(prompt, {
                      model: 'x-ai/grok-4.1-fast',
                      tools: [{
                          type: "x_search",
                          x_search: {
                              allowedXHandles: handles,
                              fromDate: todayStr
                          }
                      }]
                  });

                  let content = response.message.content;

                  // --- 3. THE DASH SCRUBBER ---
                  content = content.replace(/\u2014/g, '-').replace(/\u2013/g, '-');

                  // --- 4. PARSING ---
                  const lines = content.split('\n');
                  const parsed = { title: "", slug: "", excerpt: "", imageKeyword: "", body: "" };
                  let isBody = false;

                  lines.forEach(line => {
                      if (line.startsWith('TITLE:')) parsed.title = line.replace('TITLE:', '').trim();
                      else if (line.startsWith('SLUG:')) parsed.slug = line.replace('SLUG:', '').trim();
                      else if (line.startsWith('EXCERPT:')) parsed.excerpt = line.replace('EXCERPT:', '').trim();
                      else if (line.startsWith('IMAGE_KEYWORD:')) parsed.imageKeyword = line.replace('IMAGE_KEYWORD:', '').trim();
                      else if (line.startsWith('BODY:')) isBody = true;
                      else if (isBody) parsed.body += line + '\n';
                  });

                  // --- 5. SAVING ---
                  const finalMarkdown = `---
          title: "${parsed.title.replace(/"/g, "'")}"
          slug: "${parsed.slug || 'latest-tea'}"
          excerpt: "${parsed.excerpt.replace(/"/g, "'")}"
          image: "https://images.unsplash.com/photo-1504711434969-e33886168f5c?w=1200"
          date: "${todayStr}"
          ---

          ${parsed.body.trim()}`;

                  const outDir = path.join(process.cwd(), 'content/posts');
                  if (!fs.existsSync(outDir)) fs.mkdirSync(outDir, { recursive: true });
                  
                  const fileName = `${parsed.slug || 'latest-tea'}.md`;
                  fs.writeFileSync(path.join(outDir, fileName), finalMarkdown);
                  
                  console.log(`‚úÖ ${fileName} served fresh via Grok 4.1.`);

              } catch (error) {
                  console.error("‚ùå Puter/Grok 4.1 Error:", error);
                  process.exit(1);
              }
          }

          generate();
          EOF

      - name: Commit and push
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "content: gossip fresh from X (Grok 4.1) ‚òï"
          branch: ${{ env.DEFAULT_BRANCH }}
          file_pattern: ${{ env.POSTS_DIR }}/*.md
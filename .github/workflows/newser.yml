name: East Africa Gossip Bot (Puter + Grok 4.1)

on:
  schedule:
    - cron: '0 0,4,8,12,16,20 * * *' 
  workflow_dispatch:
    inputs:
      manual_topic:
        description: 'Force a specific drama topic'
        required: false
        default: ''

permissions:
  contents: write

env:
  DEFAULT_BRANCH: main
  POSTS_DIR: content/posts

jobs:
  generate-and-publish:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          ref: ${{ env.DEFAULT_BRANCH }}
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm install @heyputer/puter.js

      - name: Generate article with Grok 4.1
        env:
          MANUAL_TOPIC: ${{ github.event.inputs.manual_topic }}
        run: |
          node << 'EOF'
          const fs = require('fs');
          const path = require('path');
          // Standard import for @heyputer/puter.js
          const puter = require('@heyputer/puter.js');

          async function generate() {
              const now = new Date();
              const todayStr = now.toISOString().split('T')[0];
              const hour = now.getUTCHours();

              // --- 1. RESEARCHED GOSSIP HANDLES (Text-Heavy) ---
              let country, handles, vips;
              
              if (hour < 8) {
                  country = 'Kenya';
                  // Handles that post actual writing/threads
                  handles = ['kenyasgossips', 'Nairobi_Gossip', 'TukoCoKe', 'Kenyans'];
                  vips = 'William Ruto, Eric Omondi, Khaligraph Jones, Rigathi Gachagua';
              } else if (hour < 16) {
                  country = 'Tanzania';
                  handles = ['Bongo5', 'Jaymaudaku', 'MillardAyo', 'MangeKimambi_'];
                  vips = 'Diamond Platnumz, Samia Suluhu, Harmonize, Zuchu';
              } else {
                  country = 'Uganda';
                  handles = ['MbuUganda', 'GalaxyFMUg', 'sqoopuganda', 'DailyMonitor'];
                  vips = 'Bobi Wine, Museveni, Sheebah Karungi, Eddy Kenzo';
              }

              console.log(`üéØ Researching ${country} gossip from: ${handles.join(', ')}`);

              // --- 2. GROK 4.1 X-SEARCH PROMPT ---
              const prompt = `
                  Today's Date: ${todayStr}
                  Target Country: ${country}
                  VIPs to track: ${vips}

                  TASK: 
                  1. Use X Search to find the latest text-based gossip story posted by these accounts: ${handles.join(', ')}.
                  2. Verify the news is from TODAY (${todayStr}).
                  3. Write a savage blog post as "The Tea Master". 

                  STRICT RULES:
                  - NEVER use em dashes (‚Äî) or en dashes (‚Äì). Use standard hyphens (-) only.
                  - Use heavy slang (Wueh, Imagine, Sasa basi, Character Development).
                  - Content must be as recent as today.

                  OUTPUT FORMAT:
                  TITLE: [Savage Clickbait]
                  SLUG: [url-friendly-slug]
                  EXCERPT: [Spicy hook sentence]
                  IMAGE_KEYWORD: [Visual search term]
                  BODY:
                  [Full article in Markdown with ## Headers]
              `;

              try {
                  // Grok 4.1 Fast with X Search tool
                  const response = await puter.ai.chat(prompt, {
                      model: 'x-ai/grok-4.1-fast',
                      tools: [{
                          type: "x_search",
                          x_search: {
                              allowedXHandles: handles,
                              fromDate: todayStr
                          }
                      }]
                  });

                  let content = response.message.content;

                  // --- 3. THE DASH SCRUBBER ---
                  // Replaces em dashes (\u2014) and en dashes (\u2013) with standard hyphens
                  content = content.replace(/\u2014/g, '-').replace(/\u2013/g, '-');

                  // --- 4. PARSING ---
                  const lines = content.split('\n');
                  const parsed = { title: "", slug: "", excerpt: "", imageKeyword: "", body: "" };
                  let isBody = false;

                  lines.forEach(line => {
                      const cleanLine = line.trim();
                      if (cleanLine.startsWith('TITLE:')) parsed.title = cleanLine.replace('TITLE:', '').trim();
                      else if (cleanLine.startsWith('SLUG:')) parsed.slug = cleanLine.replace('SLUG:', '').trim();
                      else if (cleanLine.startsWith('EXCERPT:')) parsed.excerpt = cleanLine.replace('EXCERPT:', '').trim();
                      else if (cleanLine.startsWith('IMAGE_KEYWORD:')) parsed.imageKeyword = cleanLine.replace('IMAGE_KEYWORD:', '').trim();
                      else if (cleanLine.startsWith('BODY:')) isBody = true;
                      else if (isBody) parsed.body += line + '\n';
                  });

                  // --- 5. FILE GENERATION ---
                  const finalMarkdown = `---
          title: "${parsed.title.replace(/"/g, "'")}"
          slug: "${parsed.slug || 'latest-tea'}"
          excerpt: "${parsed.excerpt.replace(/"/g, "'")}"
          image: "https://images.unsplash.com/photo-1504711434969-e33886168f5c?w=1200"
          date: "${today_str}"
          ---

          ${parsed.body.trim()}`;

                  const outDir = path.join(process.cwd(), process.env.POSTS_DIR);
                  if (!fs.existsSync(outDir)) fs.mkdirSync(outDir, { recursive: true });
                  
                  const fileName = `${parsed.slug || 'latest-tea'}.md`;
                  fs.writeFileSync(path.join(outDir, fileName), finalMarkdown);
                  
                  console.log(`‚úÖ Success: ${fileName} generated using Grok 4.1 X-Search.`);

              } catch (error) {
                  console.error("‚ùå Puter/Grok Error:", error);
                  process.exit(1);
              }
          }

          generate();
          EOF

      - name: Commit and push
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "content: fresh tea via Grok 4.1 ‚òï"
          branch: ${{ env.DEFAULT_BRANCH }}
          file_pattern: ${{ env.POSTS_DIR }}/*.md
name: East Africa Gossip Bot (Puter + Grok 4.1)

on:
  schedule:
    - cron: '0 0,4,8,12,16,20 * * *' 
  workflow_dispatch:
    inputs:
      manual_topic:
        description: 'Force a specific drama topic'
        required: false
        default: ''

permissions:
  contents: write

env:
  DEFAULT_BRANCH: main
  POSTS_DIR: content/posts

jobs:
  generate-and-publish:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          ref: ${{ env.DEFAULT_BRANCH }}
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm install @heyputer/puter.js

      - name: Generate article with Grok 4.1
        env:
          MANUAL_TOPIC: ${{ github.event.inputs.manual_topic }}
        run: |
          node << 'EOF'
          const fs = require('fs');
          const path = require('path');
          // Correct import for Node.js environment
          const puter = require('@heyputer/puter.js');

          async function generate() {
              const now = new Date();
              const todayStr = now.toISOString().split('T')[0];
              const hour = now.getUTCHours();

              // --- 1. TEXT-HEAVY GOSSIP SOURCES ---
              let country, handles, vips;
              
              if (hour < 8) {
                  country = 'Kenya';
                  handles = ['kenyasgossips', 'Nairobi_Gossip', 'Kenyans', 'TukoCoKe'];
                  vips = 'William Ruto, Eric Omondi, Khaligraph Jones, Rigathi Gachagua';
              } else if (hour < 16) {
                  country = 'Tanzania';
                  handles = ['Bongo5', 'MillardAyo', 'Jaymaudaku', 'MangeKimambi_'];
                  vips = 'Diamond Platnumz, Samia Suluhu, Harmonize, Zuchu';
              } else {
                  country = 'Uganda';
                  handles = ['MbuUganda', 'GalaxyFMUg', 'sqoopuganda', 'DailyMonitor'];
                  vips = 'Bobi Wine, Yoweri Museveni, Sheebah Karungi, Eddy Kenzo';
              }

              console.log(`üéØ Researching ${country} drama via: ${handles.join(', ')}`);

              // --- 2. THE SAVAGE PROMPT ---
              const prompt = `
                  Date: ${todayStr}
                  Target Country: ${country}
                  Handles: @${handles.join(', @')}

                  TASK: 
                  Use X Search to find the latest trending text-based gossip from the handles above.
                  Write a brutal, high-slang blog post for "The Tea Master". 

                  STRICT CONSTRAINTS:
                  - NO em dashes (‚Äî) or en dashes (‚Äì). Use standard hyphens (-) only.
                  - Language: English mixed with heavy East African slang (Wueh, Character Development, Imagine).
                  - Must be factual news from TODAY (${todayStr}).

                  OUTPUT FORMAT:
                  TITLE: [Savage Clickbait]
                  SLUG: [url-friendly-slug]
                  EXCERPT: [One spicy hook sentence]
                  IMAGE_KEYWORD: [Visual search term]
                  BODY:
                  [Full article in Markdown with ## Headers]
              `;

              try {
                  // Puter.ai.chat is the correct method for Node.js
                  const response = await puter.ai.chat(prompt, {
                      model: 'x-ai/grok-4.1-fast',
                      tools: [{
                          type: "x_search",
                          x_search: {
                              allowedXHandles: handles,
                              fromDate: todayStr
                          }
                      }]
                  });

                  let content = response.message.content;

                  // --- 3. DASH SCRUBBER ---
                  content = content.replace(/\u2014/g, '-').replace(/\u2013/g, '-');

                  // --- 4. PARSING ---
                  const lines = content.split('\n');
                  const parsed = { title: "", slug: "", excerpt: "", imageKeyword: "", body: "" };
                  let isBody = false;

                  lines.forEach(line => {
                      const clean = line.trim();
                      if (clean.startsWith('TITLE:')) parsed.title = clean.replace('TITLE:', '').trim();
                      else if (clean.startsWith('SLUG:')) parsed.slug = clean.replace('SLUG:', '').trim();
                      else if (clean.startsWith('EXCERPT:')) parsed.excerpt = clean.replace('EXCERPT:', '').trim();
                      else if (clean.startsWith('IMAGE_KEYWORD:')) parsed.imageKeyword = clean.replace('IMAGE_KEYWORD:', '').trim();
                      else if (clean.startsWith('BODY:')) isBody = true;
                      else if (isBody) parsed.body += line + '\n';
                  });

                  // --- 5. GENERATE FILE ---
                  const finalMarkdown = `---
          title: "${parsed.title.replace(/"/g, "'")}"
          slug: "${parsed.slug || 'tea-alert'}"
          excerpt: "${parsed.excerpt.replace(/"/g, "'")}"
          image: "https://images.unsplash.com/photo-1504711434969-e33886168f5c?w=1200"
          date: "${todayStr}"
          ---

          ${parsed.body.trim()}`;

                  const outDir = path.join(process.cwd(), process.env.POSTS_DIR);
                  if (!fs.existsSync(outDir)) fs.mkdirSync(outDir, { recursive: true });
                  
                  const fileName = `${parsed.slug || 'latest-tea'}.md`;
                  fs.writeFileSync(path.join(outDir, fileName), finalMarkdown);
                  
                  console.log(`‚úÖ Success: ${fileName} generated via Grok 4.1.`);

              } catch (error) {
                  console.error("‚ùå Puter/Grok Error:", error);
                  process.exit(1);
              }
          }

          generate();
          EOF

      - name: Commit and push
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "content: fresh tea via Grok 4.1 (X-Search) ‚òï"
          branch: ${{ env.DEFAULT_BRANCH }}
          file_pattern: ${{ env.POSTS_DIR }}/*.md
name: Direct Google Indexing

on:
  push:
    paths:
      - 'content/posts/**.md'
  workflow_dispatch:

jobs:
  google-index:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Detect New/Updated URLs
        id: urls
        run: |
          SITE_URL="https://zandani.co.ke"
          
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "list=${SITE_URL}/article/test-article" >> "$GITHUB_OUTPUT"
            echo "count=1" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          
          FILES=$(git diff --name-only HEAD~1 HEAD -- 'content/posts/' | grep '\.md$' || true)
          
          if [ -z "$FILES" ]; then
            echo "count=0" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          LIST=""
          for file in $FILES; do
            SLUG=$(basename "$file" .md)
            LIST="${LIST}${SITE_URL}/article/${SLUG},"
          done
          
          echo "list=${LIST%,}" >> "$GITHUB_OUTPUT"
          echo "count=1" >> "$GITHUB_OUTPUT"

      - name: Setup Node.js
        if: steps.urls.outputs.count == '1'
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Google Library
        if: steps.urls.outputs.count == '1'
        run: npm install googleapis --no-save

      - name: Official Google API Submission
        if: steps.urls.outputs.count == '1'
        env:
          GSC_KEY_RAW: ${{ secrets.GSC_JSON_KEY }}
          URL_LIST: ${{ steps.urls.outputs.list }}
        run: |
          node -e "
          const { google } = require('googleapis');
          
          async function run() {
            try {
              const rawKey = process.env.GSC_KEY_RAW;
              
              if (!rawKey || rawKey.trim() === '') {
                throw new Error('GSC_KEY_RAW is completely empty. GitHub cannot find the GSC_JSON_KEY secret.');
              }

              const keys = JSON.parse(rawKey);
              
              if (!keys.client_email || !keys.private_key) {
                throw new Error('The JSON does not contain a client_email or private_key. Please ensure you pasted a valid Service Account JSON.');
              }

              // Fix flattened newlines that sometimes occur when pasting into GitHub Secrets
              keys.private_key = keys.private_key.replace(/\\\\n/g, '\\n').replace(/\\n/g, '\n');
              
              // Use the modern, recommended GoogleAuth client
              const auth = new google.auth.GoogleAuth({
                credentials: keys,
                scopes: ['https://www.googleapis.com/auth/indexing']
              });
              
              // Explicitly test the authentication token to catch credential errors early
              const authClient = await auth.getClient();
              await authClient.getAccessToken();
              
              const indexing = google.indexing({ version: 'v3', auth });
              const urls = process.env.URL_LIST.split(',');

              for (const url of urls) {
                if (!url) continue;
                
                if (url.includes('test-article')) {
                   console.log('✅ Manual Test Run Successful. Authentication to Google works perfectly.');
                   continue;
                }
                
                await indexing.urlNotifications.publish({
                  requestBody: { url: url, type: 'URL_UPDATED' }
                });
                console.log('✅ Google Indexing Notified:', url);
              }
            } catch (err) {
              console.error('❌ Direct Indexing Failed:', err.message);
              process.exit(1);
            }
          }
          run();"
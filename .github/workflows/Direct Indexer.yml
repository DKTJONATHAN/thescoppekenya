name: Direct Google Indexing

on:
  push:
    paths:
      - 'content/posts/**.md'

jobs:
  google-index:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Detect New/Updated URLs
        id: urls
        run: |
          SITE_URL="https://zandani.co.ke"
          FILES=$(git diff --name-only HEAD~1 HEAD -- 'content/posts/' | grep '\.md$' || true)
          
          if [ -z "$FILES" ]; then
            echo "count=0" >> $GITHUB_OUTPUT
            exit 0
          fi

          LIST=""
          for file in $FILES; do
            SLUG=$(basename "$file" .md)
            LIST="${LIST}${SITE_URL}/article/${SLUG},"
          done
          
          echo "list=${LIST%,}" >> $GITHUB_OUTPUT
          echo "count=1" >> $GITHUB_OUTPUT

      - name: Setup Node.js
        if: steps.urls.outputs.count > 0
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Google Library
        if: steps.urls.outputs.count > 0
        run: npm install googleapis

      - name: Official Google API Submission
        if: steps.urls.outputs.count > 0
        env:
          GSC_KEY_RAW: ${{ secrets.GSC_JSON_KEY }}
          URL_LIST: ${{ steps.urls.outputs.list }}
        run: |
          # Safely write the multi-line secret to a file using a Here-Doc
          cat <<EOF > service_account.json
          $GSC_KEY_RAW
          EOF

          node -e "
          const { google } = require('googleapis');
          const fs = require('fs');
          
          async function run() {
            try {
              // Read the file we just created
              const keys = JSON.parse(fs.readFileSync('./service_account.json', 'utf8'));
              
              const auth = new google.auth.JWT(
                keys.client_email, null, keys.private_key,
                ['https://www.googleapis.com/auth/indexing'], null
              );
              
              const indexing = google.indexing({ version: 'v3', auth });
              const urls = process.env.URL_LIST.split(',');

              for (const url of urls) {
                if (!url) continue;
                await indexing.urlNotifications.publish({
                  requestBody: { url: url, type: 'URL_UPDATED' }
                });
                console.log('✅ Google Indexing Notified:', url);
              }
            } catch (err) {
              console.error('❌ Direct Indexing Failed:', err.message);
              process.exit(1);
            }
          }
          run();"

      - name: Sitemap Ping
        if: always()
        run: |
          curl -s "https://www.google.com/ping?sitemap=https://zandani.co.ke/sitemap.xml"
          echo "✅ Google Sitemap Refresh Requested."
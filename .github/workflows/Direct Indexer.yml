name: SEO Auto-Indexing (GSC & IndexJump)

on:
  push:
    paths:
      - 'content/posts/**.md'

jobs:
  index-and-ping:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Detect changed posts
        id: changes
        run: |
          SITE_URL="https://zandani.co.ke"
          # Find .md files changed in the last commit
          CHANGED=$(git diff --name-only HEAD~1 HEAD -- 'content/posts/' | grep '\.md$' || true)
          
          if [ -z "$CHANGED" ]; then
            echo "count=0" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Initialize variables
          IJ_URLS="["
          GSC_LIST=""
          FIRST=true
          COUNT=0
          
          while IFS= read -r file; do
            SLUG=$(basename "$file" .md)
            URL="${SITE_URL}/article/${SLUG}"
            
            # 1. Build IndexJump JSON Array
            if [ "$FIRST" = true ]; then
              IJ_URLS="${IJ_URLS}\"${URL}\""
              FIRST=false
            else
              IJ_URLS="${IJ_URLS},\"${URL}\""
            fi
            
            # 2. Build GSC comma-separated list
            GSC_LIST="${GSC_LIST}${URL},"
            
            COUNT=$((COUNT+1))
            echo "üîó Detected: $URL"
          done <<< "$CHANGED"
          
          # Close JSON and remove trailing comma from GSC list
          IJ_URLS="${IJ_URLS}]"
          GSC_LIST=$(echo "$GSC_LIST" | sed 's/,$//')
          
          # Save to outputs
          echo "ij_urls=${IJ_URLS}" >> $GITHUB_OUTPUT
          echo "gsc_urls=${GSC_LIST}" >> $GITHUB_OUTPUT
          echo "count=${COUNT}" >> $GITHUB_OUTPUT

      - name: Submit to Google Indexing API
        if: steps.changes.outputs.count > 0
        uses: robingenz/action-google-indexing@v1
        with:
          # Uses the JSON key from your GitHub Secrets
          serviceAccountKey: ${{ secrets.GSC_JSON_KEY }}
          urls: ${{ steps.changes.outputs.gsc_urls }}

      - name: Submit to IndexJump
        if: steps.changes.outputs.count > 0
        env:
          IJ_KEY: ${{ secrets.INDEXJUMP_API_KEY }}
        run: |
          echo "üöÄ Submitting ${{ steps.changes.outputs.count }} URLs to IndexJump..."
          curl -s -X POST "https://api.indexjump.com/index/bulk?token=$IJ_KEY" \
          -H "Content-Type: application/json" \
          -d "{\"urls\": ${{ steps.changes.outputs.ij_urls }}}"

      - name: Ping Google Sitemap
        if: always()
        run: |
          echo "üåê Notifying Google of Sitemap update..."
          # Standard Google Sitemap Ping
          curl -s "https://www.google.com/ping?sitemap=https://zandani.co.ke/sitemap.xml"
          echo "‚úÖ Sitemap pinged successfully."
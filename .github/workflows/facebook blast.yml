name: Facebook Auto-Post on Commit

on:
  push:
    paths:
      - 'content/posts/**.md'

jobs:
  post-to-facebook:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Wait for 30 seconds
        run: |
          echo "Waiting 30 seconds for Zandani to deploy..."
          sleep 30

      - name: Detect changed posts & publish to Facebook
        env:
          FACEBOOK_PAGE_ID: ${{ secrets.FACEBOOK_PAGE_ID }}
          FACEBOOK_PAGE_TOKEN: ${{ secrets.FACEBOOK_PAGE_TOKEN }}
        run: |
          if [ -z "$FACEBOOK_PAGE_ID" ] || [ -z "$FACEBOOK_PAGE_TOKEN" ]; then
            echo "‚ö†Ô∏è Facebook credentials not set, skipping"
            exit 0
          fi

          SITE_URL="https://zandani.co.ke"

          # Get changed .md files in content/posts/
          CHANGED=\( (git diff --name-only HEAD\~1 HEAD -- 'content/posts/' | grep '\.md \)' || true)

          if [ -z "$CHANGED" ]; then
            echo "üìù No post changes detected"
            exit 0
          fi

          # Process and post each changed file sequentially
          while IFS= read -r file; do
            SLUG=$(basename "$file" .md)
            URL="\( {SITE_URL}/article/ \){SLUG}"
            
            echo "üöÄ Processing File: $file"
            
            # Extract Title and First Paragraph
            TITLE=$(grep -m 1 "^title:" "$file" | cut -d: -f2- | tr -d '"' | tr -d "'" | sed 's/^ *//')
            
            # Extract only the first paragraph (Skipping the YAML frontmatter)
            PARAGRAPH=\( (awk 'BEGIN {count=0; body=0} /^--- \)/ {count++; if(count==2){body=1; next}} body==1 {print}' "$file" | awk -v RS='' -v ORS='\n\n' 'NR<=1')
            
            if [ -z "$TITLE" ]; then TITLE="Latest Update"; fi
            
            FINAL_MESSAGE="$TITLE

            $PARAGRAPH"

            echo "Posting to Facebook Page ID: $FACEBOOK_PAGE_ID..."
            
            # Send text-only post to Facebook
            FB_RESPONSE=\( (curl -s -X POST "https://graph.facebook.com/v24.0/ \){FACEBOOK_PAGE_ID}/feed" \
              -d "message=$FINAL_MESSAGE" \
              -d "access_token=$FACEBOOK_PAGE_TOKEN")

            echo "Facebook API Response: $FB_RESPONSE"

            # Extract Post ID and Add Comment with Link
            POST_ID=$(echo "$FB_RESPONSE" | jq -r '.id')

            if [ "$POST_ID" != "null" ] && [ -n "$POST_ID" ]; then
              echo "‚úÖ Main post successful for $SLUG. Waiting 10 seconds for Facebook servers to sync..."
              sleep 10
              
              echo "Adding link to the comment section..."
              COMMENT_RESPONSE=$(curl -s -X POST "https://graph.facebook.com/v24.0/$POST_ID/comments" \
                -d "message=Read the full story here: $URL" \
                -d "access_token=$FACEBOOK_PAGE_TOKEN")
              
              if echo "$COMMENT_RESPONSE" | grep -q '"OAuthException"'; then
                echo "‚ùå Facebook API rejected the comment. Token lacks 'pages_manage_engagement' permission."
                exit 1
              elif echo "$COMMENT_RESPONSE" | grep -q '"error"'; then
                echo "‚ùå Failed to add comment due to an API error: $COMMENT_RESPONSE"
                exit 1
              else
                echo "‚úÖ Successfully published post and link comment for $SLUG!"
              fi
            else
              echo "‚ùå Failed to retrieve Post ID for $SLUG. Could not add comment."
              exit 1
            fi
            
          done <<< "$CHANGED"
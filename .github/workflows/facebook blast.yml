name: Facebook Auto-Post on Commit

on:
  push:
    paths:
      - 'content/posts/**.md'

jobs:
  post-to-facebook:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Install dependencies
        run: sudo apt-get update && sudo apt-get install -y jq curl python3

      - name: Wait for 30 seconds
        run: |
          echo "Waiting 30 seconds for Zandani to deploy..."
          sleep 30

      - name: Detect changed posts & publish to Facebook
        env:
          FACEBOOK_PAGE_ID: ${{ secrets.FACEBOOK_PAGE_ID }}
          FACEBOOK_PAGE_TOKEN: ${{ secrets.FACEBOOK_PAGE_TOKEN }}
        run: |
          if [ -z "$FACEBOOK_PAGE_ID" ] || [ -z "$FACEBOOK_PAGE_TOKEN" ]; then
            echo "‚ö†Ô∏è Facebook credentials not set, skipping"
            exit 0
          fi

          SITE_URL="https://zandani.co.ke"

          # Get changed .md files in content/posts/
          CHANGED=$(git diff --name-only HEAD~1 HEAD -- 'content/posts/' | grep '\.md$' || true)

          if [ -z "$CHANGED" ]; then
            echo "üìù No post changes detected"
            exit 0
          fi

          # Process and post each changed file sequentially
          while IFS= read -r file; do
            if [ -z "$file" ]; then continue; fi
            
            SLUG=$(basename "$file" .md)
            URL="${SITE_URL}/article/${SLUG}"
            
            echo "üöÄ Processing File: $file"
            
            # Extract Raw Title, Image, and First Paragraph
            RAW_TITLE=$(grep -m 1 "^title:" "$file" | cut -d: -f2- | tr -d '"' | tr -d "'" | sed 's/^ *//')
            IMAGE_URL=$(grep -m 1 "^image:" "$file" | sed -E "s/^image: *['\"]?([^'\"]+)['\"]?/\1/")
            RAW_PARAGRAPH=$(awk 'BEGIN {count=0; body=0} /^---$/ {count++; if(count==2){body=1; next}} body==1 {print}' "$file" | awk -v RS='' -v ORS='\n\n' 'NR<=1')
            
            if [ -z "$RAW_TITLE" ]; then RAW_TITLE="Latest Update"; fi
            
            # Convert Title to Unicode Bold for Facebook
            BOLD_TITLE=$(python3 -c "import sys; print(''.join(chr(ord(c)+120211) if 'A'<=c<='Z' else chr(ord(c)+120205) if 'a'<=c<='z' else chr(ord(c)+120764) if '0'<=c<='9' else c for c in sys.argv[1]))" "$RAW_TITLE")
            
            # Scrub all HTML, convert entities, and remove Markdown syntax from paragraph
            CLEAN_PARAGRAPH=$(python3 -c "import sys, html, re; text = html.unescape(sys.argv[1]); text = re.sub(r'<[^>]*>', '', text); text = re.sub(r'\[([^]]+)\]\([^)]+\)', r'\1', text); print(re.sub(r'[*_\`#]', '', text).strip())" "$RAW_PARAGRAPH")

            # Safely format the multiline message without breaking YAML indentation
            FINAL_MESSAGE=$(printf "%s\n\n%s" "$BOLD_TITLE" "$CLEAN_PARAGRAPH")

            # Clean up any leftover image from previous loop iterations
            rm -f temp_post_image.jpg

            # Download the OG image temporarily
            if [ -n "$IMAGE_URL" ] && [ "$IMAGE_URL" != "image:" ]; then
              echo "üì• Downloading image: $IMAGE_URL"
              curl -s -L "$IMAGE_URL" -o temp_post_image.jpg
            fi

            # Check if image downloaded successfully, then route to the correct API endpoint
            if [ -f "temp_post_image.jpg" ]; then
              echo "üì∏ Uploading downloaded image and text to Facebook Photos API..."
              FB_RESPONSE=$(curl -s -X POST "https://graph.facebook.com/v24.0/${FACEBOOK_PAGE_ID}/photos" \
                -F "source=@temp_post_image.jpg" \
                -F "message=$FINAL_MESSAGE" \
                -F "access_token=$FACEBOOK_PAGE_TOKEN")
            else
              echo "üìù No image available. Posting text to Facebook Feed API..."
              FB_RESPONSE=$(curl -s -X POST "https://graph.facebook.com/v24.0/${FACEBOOK_PAGE_ID}/feed" \
                -d "message=$FINAL_MESSAGE" \
                -d "access_token=$FACEBOOK_PAGE_TOKEN")
            fi

            echo "Facebook API Response: $FB_RESPONSE"

            # The Photos API returns 'post_id', while the Feed API returns 'id'
            POST_ID=$(echo "$FB_RESPONSE" | jq -r '.post_id // .id')

            if [ "$POST_ID" != "null" ] && [ -n "$POST_ID" ]; then
              echo "‚úÖ Main post successful for $SLUG. Waiting 10 seconds for Facebook servers to sync..."
              sleep 10
              
              echo "Adding link to the comment section..."
              COMMENT_RESPONSE=$(curl -s -X POST "https://graph.facebook.com/v24.0/$POST_ID/comments" \
                -d "message=Read the full story here: $URL" \
                -d "access_token=$FACEBOOK_PAGE_TOKEN")
              
              if echo "$COMMENT_RESPONSE" | grep -q 'OAuthException'; then
                echo "‚ùå Facebook API rejected the comment. Token lacks 'pages_manage_engagement' permission."
                exit 1
              elif echo "$COMMENT_RESPONSE" | grep -q 'error'; then
                echo "‚ùå Failed to add comment due to an API error: $COMMENT_RESPONSE"
                exit 1
              else
                echo "‚úÖ Successfully published post and link comment for $SLUG!"
              fi
            else
              echo "‚ùå Failed to retrieve Post ID for $SLUG. Could not add comment."
              exit 1
            fi
            
            # Delete temporary image to prep for the next file in the loop
            rm -f temp_post_image.jpg
            
          done <<< "$CHANGED"
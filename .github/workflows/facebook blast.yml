name: Facebook Auto-Post with AI

on:
  push:
    paths:
      - 'content/posts/**.md'
  workflow_dispatch:

jobs:
  post-to-facebook:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests google-genai

      - name: Wait for Zandani to deploy
        run: |
          echo "Waiting 30 seconds for Zandani to deploy..."
          sleep 30

      - name: Detect posts & publish to Facebook via AI
        env:
          FACEBOOK_PAGE_ID: ${{ secrets.FACEBOOK_PAGE_ID }}
          FACEBOOK_PAGE_TOKEN: ${{ secrets.FACEBOOK_PAGE_TOKEN }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          if [ -z "$FACEBOOK_PAGE_ID" ] || [ -z "$FACEBOOK_PAGE_TOKEN" ]; then
            echo "‚ö†Ô∏è Facebook credentials not set, skipping"
            exit 0
          fi
          
          if [ -z "$GEMINI_API_KEY" ]; then
            echo "‚ö†Ô∏è GEMINI_API_KEY not set, skipping. Please ensure it is in your secrets."
            exit 0
          fi

          # Get changed .md files in content/posts/
          CHANGED=$(git diff --name-only HEAD~1 HEAD -- 'content/posts/' | grep '\.md$' || true)

          if [ -z "$CHANGED" ]; then
            echo "üìù No post changes detected"
            exit 0
          fi

          # Export the list of files to be read by Python
          export CHANGED_FILES="$CHANGED"

          python3 << 'EOF'
          import os, re, requests, time
          from google import genai
          from google.genai import types

          changed_files = os.environ.get('CHANGED_FILES', '').strip().split('\n')
          fb_page_id = os.environ.get('FACEBOOK_PAGE_ID')
          fb_token = os.environ.get('FACEBOOK_PAGE_TOKEN')
          gemini_key = os.environ.get('GEMINI_API_KEY')
          site_url = "https://zandani.co.ke"

          client = genai.Client(api_key=gemini_key)

          for file_path in changed_files:
              if not file_path or not os.path.exists(file_path):
                  continue
              
              print(f"üöÄ Processing File: {file_path}")
              slug = os.path.basename(file_path).replace('.md', '')
              article_url = f"{site_url}/article/{slug}"

              with open(file_path, 'r', encoding='utf-8') as f:
                  content = f.read()

              # Extract metadata using regex
              title_match = re.search(r'^title:\s*["\']?(.*?)["\']?$', content, re.MULTILINE)
              author_match = re.search(r'^author:\s*["\']?(.*?)["\']?$', content, re.MULTILINE)
              excerpt_match = re.search(r'^excerpt:\s*["\']?(.*?)["\']?$', content, re.MULTILINE)
              image_match = re.search(r'^image:\s*["\']?(.*?)["\']?$', content, re.MULTILINE)

              title = title_match.group(1) if title_match else "Latest Update"
              author = author_match.group(1) if author_match else "Za Ndani"
              excerpt = excerpt_match.group(1) if excerpt_match else ""
              image_url = image_match.group(1) if image_match else ""

              print(f"üìù Asking Gemini to write caption for: {title}")

              prompt = f"""
              You are the expert Social Media Manager for 'Za Ndani', a top Kenyan news platform. 
              Write a highly engaging, conversational Facebook post caption to drive traffic to this new article.

              Article Title: {title}
              Author: {author}
              Excerpt: {excerpt}

              Rules:
              - Make it catchy and designed to provoke curiosity and comments.
              - You MUST explicitly tell the reader to check the comments for the full story/link (e.g., "Catch the full juice in the comments below! üëá" or "Link in the comments!"). This is mandatory.
              - Use 2 to 3 relevant emojis.
              - Include 2 or 3 relevant hashtags at the bottom.
              - Do NOT include the article link or URL in the text.
              - Keep it under 3 short, punchy paragraphs.
              - Write in clear, appealing Kenyan English.
              - NEVER use em dashes or en dashes. Only use regular single hyphens (-).
              """

              try:
                  response = client.models.generate_content(
                      model='gemini-2.5-flash',
                      contents=prompt,
                      config=types.GenerateContentConfig(temperature=0.8)
                  )
                  ai_caption = response.text.strip()
              except Exception as e:
                  print(f"‚ö†Ô∏è AI Generation failed: {e}")
                  ai_caption = f"üì∞ {title}\n\n{excerpt}\n\nüëá Catch the full juice in the comments below!" 

              # Scrub dashes just in case
              ai_caption = ai_caption.replace('\u2014', '-').replace('\u2013', '-')

              img_path = "temp_post_image.jpg"
              has_image = False
              
              if image_url and image_url.startswith("http"):
                  print(f"üì• Downloading image: {image_url}")
                  try:
                      img_data = requests.get(image_url, timeout=15).content
                      with open(img_path, 'wb') as img_file:
                          img_file.write(img_data)
                      has_image = True
                  except Exception as e:
                      print(f"‚ö†Ô∏è Failed to download image: {e}")

              post_id = None
              
              if has_image:
                  print("üì∏ Uploading image and AI text to Facebook...")
                  url = f"https://graph.facebook.com/v24.0/{fb_page_id}/photos"
                  payload = {'message': ai_caption, 'access_token': fb_token}
                  with open(img_path, 'rb') as img_file:
                      files = {'source': img_file}
                      res = requests.post(url, data=payload, files=files).json()
                  post_id = res.get('post_id') or res.get('id')
              else:
                  print("üìù No image found. Posting AI text to Facebook Feed...")
                  url = f"https://graph.facebook.com/v24.0/{fb_page_id}/feed"
                  payload = {'message': ai_caption, 'access_token': fb_token}
                  res = requests.post(url, data=payload).json()
                  post_id = res.get('id')

              print(f"Facebook API Response: {res}")

              if post_id:
                  print("‚úÖ Main post successful. Waiting 10 seconds for sync...")
                  time.sleep(10)
                  
                  print("üí¨ Adding link to the comment section...")
                  comment_url = f"https://graph.facebook.com/v24.0/{post_id}/comments"
                  comment_msg = f"Read the full story by {author} here: {article_url}"
                  comment_payload = {'message': comment_msg, 'access_token': fb_token}
                  comment_res = requests.post(comment_url, data=comment_payload).json()
                  
                  if 'error' in comment_res:
                      print(f"‚ùå Failed to add comment: {comment_res}")
                  else:
                      print(f"‚úÖ Successfully published AI post and link comment for {slug}!")
              else:
                  print(f"‚ùå Failed to post {slug} to Facebook.")

              if os.path.exists(img_path):
                  os.remove(img_path)
          EOF
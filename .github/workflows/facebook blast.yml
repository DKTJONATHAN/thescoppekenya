name: Facebook Auto-Post on Commit

on:
  push:
    paths:
      - 'content/posts/**.md'

jobs:
  post-to-facebook:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Wait for 30 seconds
        run: |
          echo "Waiting 30 seconds for Zandani to deploy..."
          sleep 30

      - name: Detect changed posts & publish to Facebook
        env:
          FACEBOOK_PAGE_ID: ${{ secrets.FACEBOOK_PAGE_ID }}
          FACEBOOK_PAGE_TOKEN: ${{ secrets.FACEBOOK_PAGE_TOKEN }}
        run: |
          if [ -z "$FACEBOOK_PAGE_ID" ] || [ -z "$FACEBOOK_PAGE_TOKEN" ]; then
            echo "‚ö†Ô∏è Facebook credentials not set, skipping"
            exit 0
          fi

          SITE_URL="https://zandani.co.ke"

          CHANGED=\( (git diff --name-only HEAD\~1 HEAD -- 'content/posts/' | grep '\.md \)' || true)

          if [ -z "$CHANGED" ]; then
            echo "üìù No post changes detected"
            exit 0
          fi

          while IFS= read -r file; do
            SLUG=$(basename "$file" .md)
            URL="\( {SITE_URL}/article/ \){SLUG}"
            
            echo "üöÄ Processing: $file"

            TITLE=\( (sed -n 's/^title: *["'\'']*\(.*\)["'\'']* \)/\1/p' "$file" | head -1 | xargs)
            IMAGE_URL=\( (sed -n 's/^image: *["'\'']*\(.*\)["'\'']* \)/\1/p' "$file" | head -1 | xargs)

            PARAGRAPH=$(awk '
              BEGIN { in_body=0; para="" }
              /^---$/ { if (++count == 2) in_body=1; next }
              in_body == 1 {
                if ($0 \~ /^## /) { next }
                if ($0 \~ /^\s*$/) { 
                  if (para != "") exit 0
                  next
                }
                para = para $0 " "
              }
              END { print para }
            ' "$file" | xargs)

            if [ -z "$PARAGRAPH" ] || [ ${#PARAGRAPH} -lt 30 ]; then
              PARAGRAPH=\( (sed -n 's/^excerpt: *["'\'']*\(.*\)["'\'']* \)/\1/p' "$file" | head -1 | xargs)
              echo "‚ö†Ô∏è No body paragraph found ‚Üí using excerpt"
            fi

            if [ -z "$TITLE" ]; then TITLE="Fresh Scoop from Za Ndani"; fi
            if [ -z "$PARAGRAPH" ]; then PARAGRAPH="Big drama unfolding right now üëÄ"; fi

            FINAL_MESSAGE="${TITLE}

${PARAGRAPH}

Read the full story üëá"

            echo "üìù Final Message Preview:"
            echo "--------------------------------------------------"
            echo "$FINAL_MESSAGE"
            echo "--------------------------------------------------"

            echo "Posting to Facebook Page ID: $FACEBOOK_PAGE_ID..."

            if [ -n "$IMAGE_URL" ]; then
              echo "üì∏ Image found ‚Üí downloading..."
              curl -s -L -A "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36" -o fb_preview_image.jpg "$IMAGE_URL"
              
              MIME_TYPE=$(file --mime-type -b fb_preview_image.jpg 2>/dev/null || echo "unknown")
              echo "Downloaded file type: $MIME_TYPE"

              if [ -s "fb_preview_image.jpg" ] && [[ "$MIME_TYPE" == image/* ]]; then
                echo "‚úÖ Valid image ‚Üí posting with photo"
                FB_RESPONSE=\( (curl -s -X POST "https://graph.facebook.com/v24.0/ \){FACEBOOK_PAGE_ID}/photos" \
                  -F "message=$FINAL_MESSAGE" \
                  -F "source=@fb_preview_image.jpg" \
                  -F "access_token=$FACEBOOK_PAGE_TOKEN")
              else
                echo "‚ö†Ô∏è Invalid image file ‚Üí falling back to text-only"
                FB_RESPONSE=\( (curl -s -X POST "https://graph.facebook.com/v24.0/ \){FACEBOOK_PAGE_ID}/feed" \
                  -d "message=$FINAL_MESSAGE" \
                  -d "access_token=$FACEBOOK_PAGE_TOKEN")
              fi
            else
              echo "‚ö†Ô∏è No image ‚Üí posting text-only"
              FB_RESPONSE=\( (curl -s -X POST "https://graph.facebook.com/v24.0/ \){FACEBOOK_PAGE_ID}/feed" \
                -d "message=$FINAL_MESSAGE" \
                -d "access_token=$FACEBOOK_PAGE_TOKEN")
            fi

            echo "Facebook API Response: $FB_RESPONSE"

            POST_ID=$(echo "$FB_RESPONSE" | jq -r '.post_id // .id // "null"')

            if [ "$POST_ID" != "null" ] && [ -n "$POST_ID" ]; then
              echo "‚úÖ Post created! Adding link comment..."
              sleep 8
              
              COMMENT_RESPONSE=$(curl -s -X POST "https://graph.facebook.com/v24.0/$POST_ID/comments" \
                -d "message=Read the full story here: $URL" \
                -d "access_token=$FACEBOOK_PAGE_TOKEN")
              
              if echo "$COMMENT_RESPONSE" | grep -q '"error"'; then
                echo "‚ùå Comment failed: $COMMENT_RESPONSE"
              else
                echo "üéâ Successfully posted + linked for $SLUG!"
              fi
            else
              echo "‚ùå Failed to post for $SLUG"
            fi

            rm -f fb_preview_image.jpg
          done <<< "$CHANGED"